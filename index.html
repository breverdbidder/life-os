<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life OS - Shapira Family Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --purple: #8b5cf6; --blue: #3b82f6; --green: #10b981; --orange: #f59e0b; --red: #ef4444; --whatsapp: #25D366; }
        body { background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f172a 100%); min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; }
        .glass { background: rgba(30, 30, 50, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(139, 92, 246, 0.2); }
        .glow { box-shadow: 0 0 25px rgba(139, 92, 246, 0.3); }
        .risk-high { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .risk-medium { background: rgba(245, 158, 11, 0.2); border-color: #f59e0b; }
        .risk-low { background: rgba(16, 185, 129, 0.2); border-color: #10b981; }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .whatsapp-btn { background: #25D366; }
        .whatsapp-btn:hover { background: #128C7E; }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="glass rounded-2xl p-5 mb-6 glow">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-5xl">üß†</div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                            Life OS - Shapira Family
                        </h1>
                        <p class="text-gray-400 text-sm mt-1">FOCUS-Optimized Task Tracking ‚Ä¢ XGBoost Risk Monitoring</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="shareStatus()" class="whatsapp-btn text-white px-4 py-2 rounded-xl flex items-center gap-2 font-semibold">
                        üì± Share
                    </button>
                    <div class="text-right">
                        <div id="current-date" class="text-lg font-semibold text-purple-400"></div>
                        <div id="current-time" class="text-2xl font-mono text-white"></div>
                        <div class="text-xs text-gray-500">üïê FL: EST | IL: IST</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOCUS Alert Banner - V3.1 FIX: Only shows for OPEN interventions -->
        <div id="focus-alert" class="glass rounded-xl p-4 mb-6 border-l-4 border-red-500 hidden">
            <div class="flex items-center gap-4">
                <div class="text-3xl pulse">‚ö†Ô∏è</div>
                <div>
                    <div class="font-semibold text-red-400">FOCUS INTERVENTION NEEDED</div>
                    <div id="alert-message" class="text-sm text-gray-400"></div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-white" id="stat-total">0</div>
                <div class="text-xs text-gray-500 uppercase">Total Tasks</div>
            </div>
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-green-400" id="stat-completed">0</div>
                <div class="text-xs text-gray-500 uppercase">Completed</div>
            </div>
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-blue-400" id="stat-progress">0</div>
                <div class="text-xs text-gray-500 uppercase">In Progress</div>
            </div>
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-orange-400" id="stat-pending">0</div>
                <div class="text-xs text-gray-500 uppercase">Pending</div>
            </div>
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-red-400" id="stat-interventions">0</div>
                <div class="text-xs text-gray-500 uppercase">Open Alerts</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Today's Tasks -->
            <div class="lg:col-span-2 glass rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <span>üìã</span> Today's Tasks
                    </h2>
                    <div class="flex gap-2" id="domain-filters">
                        <button onclick="filterTasks('all')" class="px-3 py-1 rounded-lg bg-gray-700 text-xs hover:bg-gray-600 active">All</button>
                        <button onclick="filterTasks('BUSINESS')" class="px-3 py-1 rounded-lg bg-gray-800 text-xs hover:bg-gray-600">üíº</button>
                        <button onclick="filterTasks('FAMILY')" class="px-3 py-1 rounded-lg bg-gray-800 text-xs hover:bg-gray-600">üë®‚Äçüë©‚Äçüë¶</button>
                        <button onclick="filterTasks('MICHAEL')" class="px-3 py-1 rounded-lg bg-gray-800 text-xs hover:bg-gray-600">üèä</button>
                    </div>
                </div>
                <div id="tasks-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-4">Loading tasks...</div>
                </div>
            </div>

            <!-- FOCUS Monitor -->
            <div class="space-y-6">
                <!-- Risk Overview -->
                <div class="glass rounded-xl p-5">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üß†</span> FOCUS Risk Monitor
                    </h2>
                    <canvas id="risk-chart" height="200"></canvas>
                </div>

                <!-- Recent Interventions - V3.1: Shows OPEN only -->
                <div class="glass rounded-xl p-5">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>‚ö†Ô∏è</span> Open Interventions
                    </h2>
                    <div id="interventions-list" class="space-y-2 max-h-48 overflow-y-auto">
                        <div class="text-center text-gray-500 py-4 text-sm">No open interventions ‚úÖ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Travel & Events Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Active Trip -->
            <div class="glass rounded-xl p-5 border-l-4 border-blue-500" id="trip-card">
                <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span>üöó</span> Active Trip
                </h2>
                <div id="trip-details" class="text-sm">
                    <div class="text-gray-500">No active trip</div>
                </div>
            </div>

            <!-- Swim Meet -->
            <div class="glass rounded-xl p-5 border-l-4 border-green-500">
                <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span>üèä</span> Michael's Meet
                </h2>
                <div id="swim-details" class="text-sm">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Daily Metrics -->
            <div class="glass rounded-xl p-5 border-l-4 border-purple-500">
                <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span>üìä</span> Daily Metrics
                </h2>
                <div id="metrics-details" class="text-sm space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Focus Quality</span>
                        <span id="metric-focus" class="text-white">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Completion Rate</span>
                        <span id="metric-completion" class="text-green-400">--%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Context Switches</span>
                        <span id="metric-switches" class="text-orange-400">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-xs">
            <p>Life OS v3.2 ‚Ä¢ Build: 1764867315 ‚Ä¢ Created by Ariel Shapira ‚Ä¢ Auto-refreshes every 30s ‚Ä¢ V3.2: Cache-busting + open-only interventions</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mocerqjnksmhcjzxrewo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vY2VycWpua3NtaGNqenhyZXdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzI1MjYsImV4cCI6MjA4MDEwODUyNn0.ySFJIOngWWB0aqYra4PoGFuqcbdHOx1ZV6T9-klKQDw';
        
        const headers = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' };
        
        let allTasks = [];
        let currentFilter = 'all';
        let riskChart = null;

        function updateTime() {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        function filterTasks(domain) {
            currentFilter = domain;
            renderTasks();
        }

        function renderTasks() {
            const filtered = currentFilter === 'all' ? allTasks : allTasks.filter(t => t.domain === currentFilter);
            const container = document.getElementById('tasks-list');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No tasks</div>';
                return;
            }

            container.innerHTML = filtered.map(t => {
                const statusColors = {
                    'COMPLETED': 'bg-green-900/50 text-green-300',
                    'IN_PROGRESS': 'bg-blue-900/50 text-blue-300',
                    'INITIATED': 'bg-gray-700 text-gray-300',
                    'SOLUTION_PROVIDED': 'bg-purple-900/50 text-purple-300',
                    'ABANDONED': 'bg-red-900/50 text-red-300'
                };
                const statusIcons = { 'COMPLETED': '‚úÖ', 'IN_PROGRESS': 'üîÑ', 'INITIATED': '‚è≥', 'SOLUTION_PROVIDED': 'üí°', 'ABANDONED': '‚ùå' };
                const domainIcons = { 'BUSINESS': 'üíº', 'FAMILY': 'üë®‚Äçüë©‚Äçüë¶', 'MICHAEL': 'üèä', 'PERSONAL': 'üë§' };
                
                return `
                    <div class="p-3 bg-gray-800/50 rounded-lg border-l-2 ${t.status === 'IN_PROGRESS' ? 'border-blue-500' : 'border-gray-600'}">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span>${statusIcons[t.status] || 'üìå'}</span>
                                    <span>${domainIcons[t.domain] || 'üìå'}</span>
                                    <span class="font-medium text-sm">${t.description?.substring(0, 50) || t.task_id}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Complexity: ${t.complexity || '-'} | ${t.task_id}
                                </div>
                            </div>
                            <span class="status-badge ${statusColors[t.status] || 'bg-gray-700'}">${t.status}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function fetchData() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Fetch tasks
                const tasksRes = await fetch(`${SUPABASE_URL}/rest/v1/task_states?select=*&order=initiated_at.desc`, { headers });
                const tasks = await tasksRes.json();
                allTasks = tasks;
                
                // Filter today's tasks
                const todayTasks = tasks.filter(t => t.initiated_at?.startsWith(today));
                
                // Update stats
                document.getElementById('stat-total').textContent = todayTasks.length;
                document.getElementById('stat-completed').textContent = todayTasks.filter(t => t.status === 'COMPLETED').length;
                document.getElementById('stat-progress').textContent = todayTasks.filter(t => t.status === 'IN_PROGRESS').length;
                document.getElementById('stat-pending').textContent = todayTasks.filter(t => ['INITIATED', 'SOLUTION_PROVIDED'].includes(t.status)).length;
                
                renderTasks();
                
                // ===== V3.1 FIX: Only fetch OPEN interventions (successful IS NULL) =====
                const intRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/task_interventions?successful=is.null&select=*&order=triggered_at.desc&limit=10`, 
                    { headers }
                );
                const openInterventions = await intRes.json();
                
                // Update stat with OPEN count only
                document.getElementById('stat-interventions').textContent = openInterventions.length;
                
                // Show alert ONLY if there are OPEN high-risk interventions
                const alertBanner = document.getElementById('focus-alert');
                const openHighRisk = openInterventions.find(i => i.intervention_level >= 3);
                
                if (openHighRisk) {
                    alertBanner.classList.remove('hidden');
                    document.getElementById('alert-message').textContent = openHighRisk.message || 'High-risk task needs attention';
                } else {
                    // HIDE the banner if no open high-risk interventions
                    alertBanner.classList.add('hidden');
                }
                
                // Render OPEN interventions only
                const intListHtml = openInterventions.length > 0 
                    ? openInterventions.slice(0, 5).map(i => `
                        <div class="p-2 bg-gray-800/50 rounded text-xs">
                            <div class="flex items-center gap-2">
                                <span class="${i.intervention_level >= 3 ? 'text-red-400' : i.intervention_level >= 2 ? 'text-orange-400' : 'text-yellow-400'}">
                                    ${'‚ö†Ô∏è'.repeat(i.intervention_level || 1)}
                                </span>
                                <span class="text-gray-300">${(i.task_description || i.task_id || 'Task').substring(0, 25)}</span>
                            </div>
                            <div class="text-gray-500 mt-1">${i.risk_level || ''} risk (${Math.round((i.abandonment_probability || 0) * 100)}%)</div>
                        </div>
                    `).join('')
                    : '<div class="text-center text-green-400 py-2 text-sm">‚úÖ No open interventions</div>';
                
                document.getElementById('interventions-list').innerHTML = intListHtml;
                // ===== END V3.1 FIX =====
                
                // Update risk chart
                updateRiskChart(todayTasks);
                
                // Fetch daily metrics
                const metricsRes = await fetch(`${SUPABASE_URL}/rest/v1/daily_metrics?date=eq.${today}&limit=1`, { headers });
                const metrics = await metricsRes.json();
                if (metrics[0]) {
                    document.getElementById('metric-focus').textContent = metrics[0].average_focus_quality || '--';
                    document.getElementById('metric-completion').textContent = Math.round((metrics[0].completion_rate || 0) * 100) + '%';
                    document.getElementById('metric-switches').textContent = metrics[0].context_switches || '0';
                }
                
                // Fetch travel info
                const travelRes = await fetch(`${SUPABASE_URL}/rest/v1/activities?activity_type=eq.DRIVING&platform=eq.life_os&limit=1&order=start_time.desc`, { headers });
                const travels = await travelRes.json();
                if (travels[0]) {
                    try {
                        const trip = JSON.parse(travels[0].notes || '{}');
                        document.getElementById('trip-details').innerHTML = `
                            <div class="font-medium text-blue-400">${trip.title || 'Trip'}</div>
                            <div class="text-gray-400 mt-1">${trip.origin?.substring(0, 30) || ''} ‚Üí ${trip.destination || ''}</div>
                            <div class="flex gap-4 mt-2">
                                <span>üõ£Ô∏è ${trip.distance_miles || '-'} mi</span>
                                <span>‚è±Ô∏è ${Math.floor((trip.estimated_time_minutes || 0) / 60)}h ${(trip.estimated_time_minutes || 0) % 60}m</span>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">Depart: ${trip.departure_time || 'TBD'}</div>
                        `;
                    } catch(e) {}
                }
                
                // Fetch swim meet
                const swimRes = await fetch(`${SUPABASE_URL}/rest/v1/activities?activity_type=eq.SWIM_MEET&platform=eq.life_os&limit=1&order=start_time.desc`, { headers });
                const swims = await swimRes.json();
                if (swims[0]) {
                    try {
                        const meet = JSON.parse(swims[0].notes || '{}');
                        document.getElementById('swim-details').innerHTML = `
                            <div class="font-medium text-green-400">${meet.meet_name || 'Meet'}</div>
                            <div class="text-gray-400">${meet.location || ''}</div>
                            <div class="mt-2 text-xs">
                                ${(meet.events || []).map(e => `<span class="inline-block bg-blue-900/50 px-2 py-1 rounded mr-1 mb-1">${e.event}</span>`).join('')}
                            </div>
                        `;
                    } catch(e) {}
                }
                
            } catch(e) {
                console.error('Fetch error:', e);
            }
        }

        function updateRiskChart(tasks) {
            const ctx = document.getElementById('risk-chart');
            const domains = { BUSINESS: 0, FAMILY: 0, MICHAEL: 0, PERSONAL: 0 };
            tasks.forEach(t => { if (domains[t.domain] !== undefined) domains[t.domain]++; });
            
            if (riskChart) riskChart.destroy();
            riskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Business', 'Family', 'Michael', 'Personal'],
                    datasets: [{
                        data: [domains.BUSINESS, domains.FAMILY, domains.MICHAEL, domains.PERSONAL],
                        backgroundColor: ['#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af', font: { size: 10 } } } },
                    cutout: '60%'
                }
            });
        }

        function shareStatus() {
            const completed = document.getElementById('stat-completed').textContent;
            const total = document.getElementById('stat-total').textContent;
            const msg = `üß† *Life OS Status Update*\nüìÖ ${new Date().toLocaleDateString()}\n\n‚úÖ ${completed}/${total} tasks completed\nüîó https://shapira-life-os.vercel.app`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        console.log("Life OS v3.2 loaded at", new Date().toISOString()); fetchData();
        setInterval(fetchData, 30000);
    </script>
</body>
</html>


