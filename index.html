<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life OS - Shapira Family Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --purple: #8b5cf6; --blue: #3b82f6; --green: #10b981; --orange: #f59e0b; --red: #ef4444; --whatsapp: #25D366; }
        body { background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f172a 100%); min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; }
        .glass { background: rgba(30, 30, 50, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(139, 92, 246, 0.2); }
        .glow { box-shadow: 0 0 25px rgba(139, 92, 246, 0.3); }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); animation: pulse-red 2s infinite; }
        .glow-yellow { box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
        .glow-green { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.6); } }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .timeline-dot { width: 12px; height: 12px; border-radius: 50%; }
        .risk-bar { height: 8px; border-radius: 4px; background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%); }
        .risk-indicator { width: 8px; height: 16px; background: white; border-radius: 2px; position: absolute; top: -4px; }
        .whatsapp-btn { background: #25D366; }
        .whatsapp-btn:hover { background: #128C7E; }
        .tab-btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .tab-btn.active { background: rgba(139, 92, 246, 0.3); color: white; }
        .tab-btn:not(.active) { color: #9ca3af; }
        .tab-btn:hover:not(.active) { background: rgba(139, 92, 246, 0.1); }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto px-4 py-4 max-w-7xl">
        <!-- Header -->
        <div class="glass rounded-2xl p-4 mb-4 glow">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-4xl">üè†</div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                            Life OS Command Center
                        </h1>
                        <p class="text-gray-400 text-xs mt-1">Real-Time ADHD Tracking ‚Ä¢ XGBoost Predictions ‚Ä¢ Auto-Updates 30min</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connection-status" class="flex items-center gap-2 text-sm">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-green-400">Live</span>
                    </div>
                    <div class="text-right">
                        <div id="current-time" class="text-xl font-mono text-white"></div>
                        <div id="next-update" class="text-xs text-gray-500">Next update: --</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADHD Alert Banner (shows when intervention needed) -->
        <div id="alert-banner" class="glass rounded-xl p-4 mb-4 border-l-4 border-red-500 glow-red hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">‚ö†Ô∏è</div>
                    <div>
                        <div class="text-lg font-semibold text-red-400">ADHD Intervention Needed</div>
                        <div id="alert-message" class="text-sm text-gray-300">Task at risk of abandonment</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="respondIntervention('continue')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">Continue</button>
                    <button onclick="respondIntervention('defer')" class="bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">Defer</button>
                    <button onclick="respondIntervention('abandon')" class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">Abandon</button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4 overflow-x-auto">
            <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="switchTab('tasks')">üìã Tasks</button>
            <button class="tab-btn" onclick="switchTab('timeline')">‚è±Ô∏è Timeline</button>
            <button class="tab-btn" onclick="switchTab('travel')">üöó Travel</button>
            <button class="tab-btn" onclick="switchTab('michael')">üèä Michael</button>
        </div>

        <!-- Tab Content: Dashboard -->
        <div id="tab-dashboard" class="tab-content">
            <!-- ADHD Metrics Row -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                <div class="glass rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-white" id="tasks-today">0</div>
                    <div class="text-xs text-gray-400">Tasks Today</div>
                </div>
                <div class="glass rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-green-400" id="completed-count">0</div>
                    <div class="text-xs text-gray-400">Completed</div>
                </div>
                <div class="glass rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-400" id="in-progress-count">0</div>
                    <div class="text-xs text-gray-400">In Progress</div>
                </div>
                <div class="glass rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-red-400" id="abandoned-count">0</div>
                    <div class="text-xs text-gray-400">Abandoned</div>
                </div>
                <div class="glass rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold" id="completion-rate">--%</div>
                    <div class="text-xs text-gray-400">Completion Rate</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                <!-- XGBoost ADHD Monitor -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <span>üß†</span> XGBoost ADHD Monitor
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">Abandonment Risk</span>
                                <span id="risk-value" class="font-bold">0%</span>
                            </div>
                            <div class="relative h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div id="risk-bar" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">Focus Quality</span>
                                <span id="focus-value" class="font-bold">0/10</span>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div id="focus-bar" class="h-full bg-purple-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">Energy Level</span>
                                <span id="energy-value" class="font-bold">0/10</span>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div id="energy-bar" class="h-full bg-blue-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="pt-2 border-t border-gray-700">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Context Switches</span>
                                <span id="context-switches" class="font-bold text-orange-400">0</span>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-gray-400">Interventions Today</span>
                                <span id="interventions-count" class="font-bold text-red-400">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Tasks -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <span>üìã</span> Active Tasks
                        <span id="active-count" class="text-xs text-gray-500">(0)</span>
                    </h3>
                    <div id="active-tasks" class="space-y-2 max-h-48 overflow-y-auto">
                        <div class="text-center text-gray-500 text-sm py-4">Loading...</div>
                    </div>
                </div>

                <!-- Daily Summary -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <span>üìà</span> Today's Summary
                    </h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
                            <span class="text-gray-400 text-sm">Productivity Score</span>
                            <span id="productivity-score" class="text-xl font-bold text-purple-400">--</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
                            <span class="text-gray-400 text-sm">Active Minutes</span>
                            <span id="active-minutes" class="font-bold text-blue-400">0</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
                            <span class="text-gray-400 text-sm">Peak Hours</span>
                            <span id="peak-hours" class="font-bold text-green-400">--</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <div id="daily-insight" class="text-xs text-gray-400 italic">
                            Loading insights...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Domain Distribution & Timeline Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3">üìä Domain Distribution</h3>
                    <canvas id="domain-chart" height="150"></canvas>
                </div>
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3">‚è∞ Task Completion Over Time</h3>
                    <canvas id="completion-chart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab Content: Tasks -->
        <div id="tab-tasks" class="tab-content hidden">
            <div class="glass rounded-xl p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">üìã All Tasks Today</h3>
                    <div class="flex gap-2">
                        <select id="task-filter" class="bg-gray-800 text-white text-sm rounded-lg px-3 py-1 border border-gray-700">
                            <option value="all">All Status</option>
                            <option value="INITIATED">Initiated</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="ABANDONED">Abandoned</option>
                        </select>
                    </div>
                </div>
                <div id="tasks-table" class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-gray-400 border-b border-gray-700">
                                <th class="text-left py-2 px-2">Time</th>
                                <th class="text-left py-2 px-2">Task</th>
                                <th class="text-left py-2 px-2">Domain</th>
                                <th class="text-center py-2 px-2">Complexity</th>
                                <th class="text-center py-2 px-2">Risk</th>
                                <th class="text-center py-2 px-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-body">
                            <tr><td colspan="6" class="text-center py-8 text-gray-500">Loading tasks...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Content: Timeline -->
        <div id="tab-timeline" class="tab-content hidden">
            <div class="glass rounded-xl p-4">
                <h3 class="text-lg font-semibold mb-4">‚è±Ô∏è Today's Timeline</h3>
                <div id="timeline-container" class="relative pl-8">
                    <div class="absolute left-3 top-0 bottom-0 w-0.5 bg-gray-700"></div>
                    <div id="timeline-events" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">Loading timeline...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Travel -->
        <div id="tab-travel" class="tab-content hidden">
            <div class="glass rounded-xl p-4 mb-4">
                <h3 class="text-lg font-semibold mb-4">üöó Today's Travel</h3>
                <div id="travel-info">
                    <div class="text-center text-gray-500 py-8">Loading travel info...</div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Michael -->
        <div id="tab-michael" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">üèä Swim Meet</h3>
                    <div id="swim-info">Loading...</div>
                </div>
                <div class="glass rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">ü•ó Nutrition</h3>
                    <div id="nutrition-info">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-xs mt-4">
            <p>Life OS v2.0 ‚Ä¢ XGBoost ADHD Monitor ‚Ä¢ Created by Ariel Shapira, Solo Founder</p>
            <p class="mt-1">Auto-updates every 30 seconds ‚Ä¢ Last update: <span id="last-update">--</span></p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mocerqjnksmhcjzxrewo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vY2VycWpua3NtaGNqenhyZXdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzI1MjYsImV4cCI6MjA4MDEwODUyNn0.ySFJIOngWWB0aqYra4PoGFuqcbdHOx1ZV6T9-klKQDw';
        
        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
        };

        let domainChart = null;
        let completionChart = null;
        let allTasks = [];
        let allInterventions = [];

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // Time display
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
            });
            
            // Next 30-min update
            const mins = now.getMinutes();
            const nextUpdate = mins < 30 ? 30 - mins : 60 - mins;
            document.getElementById('next-update').textContent = `Next update: ${nextUpdate}m`;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // XGBoost-style risk calculation
        function calculateRisk(task) {
            if (!task.initiated_at) return 0;
            
            const initiated = new Date(task.initiated_at);
            const now = new Date();
            const minutesElapsed = (now - initiated) / 60000;
            const estimated = task.estimated_minutes || 30;
            
            // Feature weights (XGBoost-style)
            const timeRatio = Math.min(minutesElapsed / estimated, 3);
            const complexityScore = (task.complexity || 5) / 10;
            const hourRisk = [0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.2, 0.1, 0.1, 0.1, 0.2, 0.5, 0.5, 0.6, 0.6, 0.5, 0.4, 0.3, 0.3, 0.4, 0.5, 0.5, 0.4][now.getHours()];
            
            const risk = (timeRatio * 0.35 + complexityScore * 0.25 + hourRisk * 0.2 + 0.2) * 100;
            return Math.min(Math.round(risk), 100);
        }

        // Intervention response
        function respondIntervention(response) {
            document.getElementById('alert-banner').classList.add('hidden');
            console.log('Intervention response:', response);
        }

        // Fetch all data
        async function fetchData() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // Fetch tasks
                const tasksRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/task_states?initiated_at=gte.${today}T00:00:00&order=initiated_at.desc`,
                    { headers }
                );
                allTasks = await tasksRes.json() || [];
                
                // Fetch interventions
                const intRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/task_interventions?triggered_at=gte.${today}T00:00:00&order=triggered_at.desc`,
                    { headers }
                );
                allInterventions = await intRes.json() || [];
                
                // Fetch daily metrics
                const metricsRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/daily_metrics?date=eq.${today}&limit=1`,
                    { headers }
                );
                const metrics = (await metricsRes.json())?.[0] || {};
                
                // Fetch activities for travel/swim
                const activitiesRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/activities?platform=eq.life_os&order=start_time.desc&limit=20`,
                    { headers }
                );
                const activities = await activitiesRes.json() || [];
                
                // Update UI
                updateDashboard(allTasks, allInterventions, metrics);
                updateTasksTable(allTasks);
                updateTimeline(allTasks, allInterventions);
                updateTravel(activities);
                updateMichael(activities);
                updateCharts(allTasks);
                
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
            } catch (e) {
                console.error('Fetch error:', e);
            }
        }

        function updateDashboard(tasks, interventions, metrics) {
            const completed = tasks.filter(t => t.status === 'COMPLETED').length;
            const abandoned = tasks.filter(t => t.status === 'ABANDONED').length;
            const inProgress = tasks.filter(t => ['INITIATED', 'IN_PROGRESS', 'SOLUTION_PROVIDED'].includes(t.status)).length;
            const total = tasks.length;
            
            document.getElementById('tasks-today').textContent = total;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('in-progress-count').textContent = inProgress;
            document.getElementById('abandoned-count').textContent = abandoned;
            document.getElementById('completion-rate').textContent = total > 0 ? `${Math.round(completed / total * 100)}%` : '--%';
            document.getElementById('completion-rate').className = `text-3xl font-bold ${completed/total > 0.7 ? 'text-green-400' : completed/total > 0.5 ? 'text-yellow-400' : 'text-red-400'}`;
            
            // XGBoost metrics
            const avgRisk = inProgress > 0 ? tasks.filter(t => ['INITIATED', 'IN_PROGRESS'].includes(t.status)).reduce((sum, t) => sum + calculateRisk(t), 0) / inProgress : 0;
            document.getElementById('risk-value').textContent = `${Math.round(avgRisk)}%`;
            document.getElementById('risk-bar').style.width = `${avgRisk}%`;
            
            const focusQuality = metrics.average_focus_quality || 5;
            document.getElementById('focus-value').textContent = `${focusQuality}/10`;
            document.getElementById('focus-bar').style.width = `${focusQuality * 10}%`;
            
            const energyLevel = 6; // Would come from health logs
            document.getElementById('energy-value').textContent = `${energyLevel}/10`;
            document.getElementById('energy-bar').style.width = `${energyLevel * 10}%`;
            
            document.getElementById('context-switches').textContent = metrics.context_switches || 0;
            document.getElementById('interventions-count').textContent = interventions.length;
            
            document.getElementById('productivity-score').textContent = metrics.productivity_score || '--';
            document.getElementById('active-minutes').textContent = `${metrics.total_active_minutes || 0}m`;
            document.getElementById('peak-hours').textContent = metrics.peak_focus_hours ? JSON.parse(metrics.peak_focus_hours).join(', ') : '9-11 AM';
            
            // Active tasks list
            const activeTasks = tasks.filter(t => ['INITIATED', 'IN_PROGRESS', 'SOLUTION_PROVIDED'].includes(t.status));
            document.getElementById('active-count').textContent = `(${activeTasks.length})`;
            
            if (activeTasks.length > 0) {
                document.getElementById('active-tasks').innerHTML = activeTasks.map(t => {
                    const risk = calculateRisk(t);
                    const riskClass = risk > 70 ? 'border-red-500 bg-red-900/20' : risk > 40 ? 'border-yellow-500 bg-yellow-900/20' : 'border-green-500 bg-green-900/20';
                    const initiated = new Date(t.initiated_at);
                    const mins = Math.round((new Date() - initiated) / 60000);
                    
                    return `
                        <div class="p-2 rounded-lg border ${riskClass}">
                            <div class="flex justify-between items-start">
                                <div class="text-sm font-medium">${t.description?.substring(0, 40) || 'Task'}...</div>
                                <span class="text-xs ${risk > 70 ? 'text-red-400' : risk > 40 ? 'text-yellow-400' : 'text-green-400'}">${risk}%</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>${t.domain || 'ARIEL'}</span>
                                <span>${mins}m ago</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('active-tasks').innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No active tasks</div>';
            }
            
            // Check for high-risk interventions
            const highRisk = activeTasks.find(t => calculateRisk(t) > 70);
            if (highRisk) {
                document.getElementById('alert-banner').classList.remove('hidden');
                document.getElementById('alert-message').textContent = `"${highRisk.description?.substring(0, 50)}..." - ${calculateRisk(highRisk)}% abandonment risk`;
            } else {
                document.getElementById('alert-banner').classList.add('hidden');
            }
            
            // Daily insight
            const insights = [];
            if (abandoned > completed) insights.push("‚ö†Ô∏è More tasks abandoned than completed today.");
            if (avgRisk > 50) insights.push("üß† High average risk - consider smaller tasks.");
            if (interventions.length > 5) insights.push("üîî Multiple interventions today - review patterns.");
            if (completed >= 5) insights.push("üéâ Great progress! 5+ tasks completed!");
            document.getElementById('daily-insight').textContent = insights[0] || "‚ú® Tracking your productivity patterns...";
        }

        function updateTasksTable(tasks) {
            const tbody = document.getElementById('tasks-body');
            
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No tasks recorded today</td></tr>';
                return;
            }
            
            const statusColors = {
                'INITIATED': 'bg-blue-900/50 text-blue-300',
                'SOLUTION_PROVIDED': 'bg-purple-900/50 text-purple-300',
                'IN_PROGRESS': 'bg-yellow-900/50 text-yellow-300',
                'COMPLETED': 'bg-green-900/50 text-green-300',
                'ABANDONED': 'bg-red-900/50 text-red-300',
                'BLOCKED': 'bg-gray-700 text-gray-300',
                'DEFERRED': 'bg-gray-700 text-gray-300'
            };
            
            const domainColors = {
                'ARIEL': 'text-purple-400',
                'MICHAEL': 'text-blue-400',
                'FAMILY': 'text-green-400',
                'BUSINESS': 'text-orange-400'
            };
            
            tbody.innerHTML = tasks.map(t => {
                const time = t.initiated_at ? new Date(t.initiated_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '--';
                const risk = calculateRisk(t);
                const riskClass = risk > 70 ? 'text-red-400' : risk > 40 ? 'text-yellow-400' : 'text-green-400';
                
                return `
                    <tr class="border-b border-gray-800 hover:bg-gray-800/30">
                        <td class="py-2 px-2 text-gray-400 text-xs">${time}</td>
                        <td class="py-2 px-2">${t.description?.substring(0, 50) || 'Task'}...</td>
                        <td class="py-2 px-2 ${domainColors[t.domain] || 'text-gray-400'}">${t.domain || 'ARIEL'}</td>
                        <td class="py-2 px-2 text-center">${t.complexity || 5}/10</td>
                        <td class="py-2 px-2 text-center ${riskClass}">${risk}%</td>
                        <td class="py-2 px-2 text-center"><span class="status-badge ${statusColors[t.status] || 'bg-gray-700'}">${t.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateTimeline(tasks, interventions) {
            const events = [];
            
            tasks.forEach(t => {
                if (t.initiated_at) events.push({ time: t.initiated_at, type: 'task_start', data: t });
                if (t.completed_at) events.push({ time: t.completed_at, type: 'task_complete', data: t });
                if (t.abandoned_at) events.push({ time: t.abandoned_at, type: 'task_abandon', data: t });
            });
            
            interventions.forEach(i => {
                events.push({ time: i.triggered_at, type: 'intervention', data: i });
            });
            
            events.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            const container = document.getElementById('timeline-events');
            
            if (events.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No events today</div>';
                return;
            }
            
            const typeConfig = {
                'task_start': { icon: 'üìã', color: 'bg-blue-500', label: 'Task Started' },
                'task_complete': { icon: '‚úÖ', color: 'bg-green-500', label: 'Completed' },
                'task_abandon': { icon: '‚ùå', color: 'bg-red-500', label: 'Abandoned' },
                'intervention': { icon: '‚ö†Ô∏è', color: 'bg-yellow-500', label: 'Intervention' }
            };
            
            container.innerHTML = events.slice(0, 20).map(e => {
                const config = typeConfig[e.type];
                const time = new Date(e.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const desc = e.type === 'intervention' ? e.data.message?.substring(0, 60) : e.data.description?.substring(0, 60);
                
                return `
                    <div class="relative flex items-start gap-4">
                        <div class="absolute left-[-20px] timeline-dot ${config.color}"></div>
                        <div class="flex-1 glass rounded-lg p-3">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2">
                                    <span>${config.icon}</span>
                                    <span class="text-sm font-medium">${config.label}</span>
                                </div>
                                <span class="text-xs text-gray-500">${time}</span>
                            </div>
                            <div class="text-sm text-gray-400 mt-1">${desc || '...'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTravel(activities) {
            const travel = activities.find(a => a.activity_type === 'DRIVING');
            const hotel = activities.find(a => a.activity_type === 'HOTEL');
            
            let html = '';
            
            if (travel) {
                try {
                    const data = JSON.parse(travel.notes || '{}');
                    html += `
                        <div class="p-4 bg-blue-900/30 rounded-lg border border-blue-500/30 mb-4">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-3xl">üöó</span>
                                <div>
                                    <div class="font-semibold text-blue-400">${data.title || 'Trip'}</div>
                                    <div class="text-sm text-gray-400">${data.departure_time || ''}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div><div class="text-2xl font-bold">${data.distance_miles || 0}</div><div class="text-xs text-gray-500">Miles</div></div>
                                <div><div class="text-2xl font-bold">${Math.floor((data.estimated_time_minutes || 0) / 60)}h ${(data.estimated_time_minutes || 0) % 60}m</div><div class="text-xs text-gray-500">Est. Time</div></div>
                                <div><div class="text-2xl font-bold text-green-400">${(data.status || 'scheduled').toUpperCase()}</div><div class="text-xs text-gray-500">Status</div></div>
                            </div>
                            <div class="mt-3 text-sm text-gray-400">
                                üìç ${data.origin || 'Origin'} ‚Üí ${data.destination || 'Destination'}
                            </div>
                        </div>
                    `;
                } catch(e) {}
            }
            
            if (hotel) {
                try {
                    const data = JSON.parse(hotel.notes || '{}');
                    html += `
                        <div class="p-4 bg-orange-900/30 rounded-lg border border-orange-500/30">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-3xl">üè®</span>
                                <div>
                                    <div class="font-semibold text-orange-400">${data.hotel_name || 'Hotel'}</div>
                                    <div class="text-sm text-gray-400">${data.address || ''}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="text-gray-500">Check-in:</span> <span class="text-white">${data.check_in || 'TBD'}</span></div>
                                <div><span class="text-gray-500">Check-out:</span> <span class="text-white">${data.check_out || 'TBD'}</span></div>
                            </div>
                        </div>
                    `;
                } catch(e) {}
            }
            
            document.getElementById('travel-info').innerHTML = html || '<div class="text-center text-gray-500 py-4">No travel scheduled</div>';
        }

        function updateMichael(activities) {
            const swim = activities.find(a => a.activity_type === 'SWIM_MEET');
            const nutrition = activities.find(a => a.activity_type === 'NUTRITION');
            
            if (swim) {
                try {
                    const data = JSON.parse(swim.notes || '{}');
                    document.getElementById('swim-info').innerHTML = `
                        <div class="text-lg font-semibold text-blue-400">${data.meet_name || 'Swim Meet'}</div>
                        <div class="text-sm text-gray-400 mb-3">üìç ${data.location || 'TBD'}</div>
                        <div class="space-y-2">
                            ${(data.events || []).map(e => `
                                <div class="flex justify-between p-2 bg-blue-900/30 rounded">
                                    <span>${e.event}</span>
                                    <span class="text-gray-400">Seed: ${e.seed_time || 'NT'}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } catch(e) {
                    document.getElementById('swim-info').innerHTML = '<div class="text-gray-500">No swim meet data</div>';
                }
            } else {
                document.getElementById('swim-info').innerHTML = '<div class="text-gray-500">No swim meet today</div>';
            }
            
            if (nutrition) {
                try {
                    const data = JSON.parse(nutrition.notes || '{}');
                    document.getElementById('nutrition-info').innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-green-400 font-semibold">${(data.diet_phase || 'standard').toUpperCase()}</span>
                            <span class="text-gray-500 text-sm">${data.meal_type || ''}</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-gray-800 rounded p-2"><div class="font-bold">${data.total_calories || 0}</div><div class="text-xs text-gray-500">Cal</div></div>
                            <div class="bg-gray-800 rounded p-2"><div class="font-bold">${data.total_protein_g || 0}g</div><div class="text-xs text-gray-500">Protein</div></div>
                            <div class="bg-gray-800 rounded p-2"><div class="font-bold">${data.total_carbs_g || 0}g</div><div class="text-xs text-gray-500">Carbs</div></div>
                        </div>
                    `;
                } catch(e) {
                    document.getElementById('nutrition-info').innerHTML = '<div class="text-gray-500">No nutrition data</div>';
                }
            } else {
                document.getElementById('nutrition-info').innerHTML = '<div class="text-gray-500">No nutrition logged</div>';
            }
        }

        function updateCharts(tasks) {
            // Domain chart
            const domains = { ARIEL: 0, MICHAEL: 0, FAMILY: 0, BUSINESS: 0 };
            tasks.forEach(t => {
                const d = t.domain || 'ARIEL';
                if (domains[d] !== undefined) domains[d]++;
            });
            
            if (domainChart) domainChart.destroy();
            domainChart = new Chart(document.getElementById('domain-chart'), {
                type: 'doughnut',
                data: {
                    labels: ['Ariel', 'Michael', 'Family', 'Business'],
                    datasets: [{
                        data: [domains.ARIEL, domains.MICHAEL, domains.FAMILY, domains.BUSINESS],
                        backgroundColor: ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b']
                    }]
                },
                options: {
                    plugins: { legend: { position: 'right', labels: { color: '#9ca3af' } } }
                }
            });
            
            // Completion over time
            const hours = Array(24).fill(0);
            tasks.filter(t => t.completed_at).forEach(t => {
                const h = new Date(t.completed_at).getHours();
                hours[h]++;
            });
            
            if (completionChart) completionChart.destroy();
            completionChart = new Chart(document.getElementById('completion-chart'), {
                type: 'bar',
                data: {
                    labels: hours.map((_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Completed',
                        data: hours,
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#9ca3af' }, grid: { display: false } },
                        y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                    }
                }
            });
        }

        // Initial load and auto-refresh
        fetchData();
        setInterval(fetchData, 30000); // 30 seconds
    </script>
</body>
</html>
