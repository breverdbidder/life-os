<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life OS - Shapira Family Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --purple: #8b5cf6; --blue: #3b82f6; --green: #10b981; 
            --orange: #f59e0b; --red: #ef4444; --whatsapp: #25D366; 
        }
        body { 
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f172a 100%); 
            min-height: 100vh; 
            font-family: system-ui, -apple-system, sans-serif; 
        }
        .glass { 
            background: rgba(30, 30, 50, 0.85); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(139, 92, 246, 0.2); 
        }
        .glow { box-shadow: 0 0 25px rgba(139, 92, 246, 0.3); }
        .glow-green { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
        .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .timeline-line { position: relative; padding-left: 24px; }
        .timeline-line::before { 
            content: ''; position: absolute; left: 8px; top: 0; bottom: 0; 
            width: 2px; background: linear-gradient(to bottom, #8b5cf6, #3b82f6); 
        }
        .timeline-dot { 
            position: absolute; left: 4px; top: 6px; width: 10px; height: 10px; 
            border-radius: 50%; background: #8b5cf6; border: 2px solid #0f0f1a;
        }
        .whatsapp-btn { background: #25D366; }
        .whatsapp-btn:hover { background: #128C7E; }
        .intervention-alert { animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .progress-ring { transform: rotate(-90deg); }
        .driving-animation { animation: drive 3s ease-in-out infinite; }
        @keyframes drive { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(10px); } }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto px-4 py-4 max-w-7xl">
        <!-- Header -->
        <div class="glass rounded-2xl p-4 mb-4 glow">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <div class="text-4xl">üè†</div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                            Life OS Command Center
                        </h1>
                        <p class="text-gray-400 text-xs">Real-Time ADHD-Optimized Tracking ‚Ä¢ Auto-updates every 30s</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="last-cron" class="text-xs text-gray-500">Last sync: --</div>
                    <button onclick="shareFullStatus()" class="whatsapp-btn text-white px-3 py-1.5 rounded-lg flex items-center gap-2 text-sm font-semibold">
                        üì± Share
                    </button>
                    <div class="text-right">
                        <div id="current-time" class="text-xl font-mono text-white"></div>
                        <div id="current-date" class="text-xs text-purple-400"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Banner for Interventions -->
        <div id="intervention-banner" class="hidden glass rounded-xl p-3 mb-4 border-l-4 border-red-500 glow-red intervention-alert">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">‚ö†Ô∏è</div>
                    <div>
                        <div class="text-sm font-semibold text-red-400" id="intervention-title">Intervention Alert</div>
                        <div class="text-xs text-gray-400" id="intervention-message"></div>
                    </div>
                </div>
                <button onclick="dismissIntervention()" class="text-gray-500 hover:text-white">‚úï</button>
            </div>
        </div>

        <!-- Active Trip Banner -->
        <div id="trip-banner" class="hidden glass rounded-xl p-3 mb-4 border-l-4 border-blue-500 glow-blue">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="text-3xl driving-animation">üöó</div>
                    <div>
                        <div class="text-sm font-semibold text-blue-400" id="trip-title">Trip</div>
                        <div class="text-xs text-gray-400" id="trip-route"></div>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-center">
                    <div><div class="text-lg font-bold text-white" id="trip-miles">--</div><div class="text-xs text-gray-500">MI</div></div>
                    <div><div class="text-lg font-bold text-white" id="trip-eta">--</div><div class="text-xs text-gray-500">ETA</div></div>
                    <div><div class="text-lg font-bold text-green-400" id="trip-status">--</div><div class="text-xs text-gray-500">STATUS</div></div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
            <!-- Left: Productivity Score + Quick Stats -->
            <div class="space-y-4">
                <!-- Productivity Score Circle -->
                <div class="glass rounded-xl p-4 text-center">
                    <div class="relative inline-block">
                        <svg class="w-28 h-28 progress-ring">
                            <circle cx="56" cy="56" r="50" stroke="#1f2937" stroke-width="8" fill="none"/>
                            <circle id="score-ring" cx="56" cy="56" r="50" stroke="#8b5cf6" stroke-width="8" fill="none"
                                    stroke-dasharray="314" stroke-dashoffset="314" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div>
                                <div id="productivity-score" class="text-2xl font-bold text-white">--</div>
                                <div class="text-xs text-gray-500">SCORE</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">Productivity Score</div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="glass rounded-lg p-3 text-center">
                        <div id="stat-completed" class="text-xl font-bold text-green-400">0</div>
                        <div class="text-xs text-gray-500">Completed</div>
                    </div>
                    <div class="glass rounded-lg p-3 text-center">
                        <div id="stat-active" class="text-xl font-bold text-blue-400">0</div>
                        <div class="text-xs text-gray-500">Active</div>
                    </div>
                    <div class="glass rounded-lg p-3 text-center">
                        <div id="stat-abandoned" class="text-xl font-bold text-red-400">0</div>
                        <div class="text-xs text-gray-500">Abandoned</div>
                    </div>
                    <div class="glass rounded-lg p-3 text-center">
                        <div id="stat-interventions" class="text-xl font-bold text-orange-400">0</div>
                        <div class="text-xs text-gray-500">Interventions</div>
                    </div>
                </div>

                <!-- ADHD Metrics -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">üß† ADHD Metrics</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">Focus Quality</span>
                                <span id="focus-value" class="text-white">7/10</span>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full">
                                <div id="focus-bar" class="h-full bg-purple-500 rounded-full" style="width: 70%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">Energy Level</span>
                                <span id="energy-value" class="text-white">7/10</span>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full">
                                <div id="energy-bar" class="h-full bg-green-500 rounded-full" style="width: 70%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">Context Switches</span>
                                <span id="switches-value" class="text-white">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center: Task Timeline -->
            <div class="lg:col-span-2 space-y-4">
                <!-- Active Tasks -->
                <div class="glass rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold flex items-center gap-2">üìã Active Tasks</h3>
                        <span id="active-count" class="text-xs text-gray-500">0 tasks</span>
                    </div>
                    <div id="active-tasks" class="space-y-2 max-h-48 overflow-y-auto">
                        <div class="text-center text-gray-500 py-4 text-sm">No active tasks</div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="glass rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold flex items-center gap-2">üìÖ Today's Timeline</h3>
                        <span id="timeline-count" class="text-xs text-gray-500">0 events</span>
                    </div>
                    <div id="timeline" class="space-y-2 max-h-64 overflow-y-auto timeline-line">
                        <div class="text-center text-gray-500 py-4 text-sm">No events yet</div>
                    </div>
                </div>

                <!-- Interventions Log -->
                <div class="glass rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold flex items-center gap-2">‚ö†Ô∏è Interventions</h3>
                        <span id="intervention-count" class="text-xs text-gray-500">0 today</span>
                    </div>
                    <div id="interventions-list" class="space-y-2 max-h-32 overflow-y-auto">
                        <div class="text-center text-gray-500 py-2 text-sm">No interventions</div>
                    </div>
                </div>
            </div>

            <!-- Right: Domain Stats + Family -->
            <div class="space-y-4">
                <!-- Domain Breakdown -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3">üìä By Domain</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-xs flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-500"></span> ARIEL</span>
                            <span id="domain-ariel" class="text-xs text-white">0/0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> MICHAEL</span>
                            <span id="domain-michael" class="text-xs text-white">0/0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> FAMILY</span>
                            <span id="domain-family" class="text-xs text-white">0/0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> BUSINESS</span>
                            <span id="domain-business" class="text-xs text-white">0/0</span>
                        </div>
                    </div>
                </div>

                <!-- Family Status -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3">üë®‚Äçüë©‚Äçüë¶ Family</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between p-2 bg-purple-900/30 rounded-lg">
                            <span class="text-xs">üë§ Ariel</span>
                            <span id="ariel-status" class="text-xs text-gray-400">--</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-blue-900/30 rounded-lg">
                            <span class="text-xs">üèä Michael</span>
                            <span id="michael-status" class="text-xs text-gray-400">--</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-green-900/30 rounded-lg">
                            <span class="text-xs">üë© Mariam</span>
                            <span class="text-xs text-gray-400">Home</span>
                        </div>
                    </div>
                </div>

                <!-- Today's Events -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3">üóìÔ∏è Events</h3>
                    <div id="events-list" class="space-y-2">
                        <div class="text-center text-gray-500 py-2 text-xs">No events</div>
                    </div>
                </div>

                <!-- Home Base -->
                <div class="glass rounded-xl p-3">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">üè†</span>
                        <div>
                            <div class="text-xs text-white">390 Roosevelt Ave</div>
                            <div class="text-xs text-gray-500">Satellite Beach, FL 32937</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-xs">
            <p>Life OS v2.0 ‚Ä¢ XGBoost ADHD Monitor ‚Ä¢ Created by Ariel Shapira</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mocerqjnksmhcjzxrewo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vY2VycWpua3NtaGNqenhyZXdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzI1MjYsImV4cCI6MjA4MDEwODUyNn0.ySFJIOngWWB0aqYra4PoGFuqcbdHOx1ZV6T9-klKQDw';
        
        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
        };

        let currentData = { tasks: [], interventions: [], activities: [], metrics: null };

        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        function updateProductivityRing(score) {
            const ring = document.getElementById('score-ring');
            const circumference = 314;
            const offset = circumference - (score / 100 * circumference);
            ring.style.strokeDashoffset = offset;
            
            // Color based on score
            if (score >= 70) ring.style.stroke = '#10b981';
            else if (score >= 50) ring.style.stroke = '#f59e0b';
            else ring.style.stroke = '#ef4444';
            
            document.getElementById('productivity-score').textContent = Math.round(score);
        }

        async function fetchAllData() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // Fetch tasks
                const tasksRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/task_states?initiated_at=gte.${today}T00:00:00&order=initiated_at.desc`,
                    { headers }
                );
                currentData.tasks = await tasksRes.json();

                // Fetch interventions
                const intRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/task_interventions?triggered_at=gte.${today}T00:00:00&order=triggered_at.desc`,
                    { headers }
                );
                currentData.interventions = await intRes.json();

                // Fetch activities (including trips)
                const actRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/activities?start_time=gte.${today}T00:00:00&order=start_time.desc`,
                    { headers }
                );
                currentData.activities = await actRes.json();

                // Fetch daily metrics
                const metRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/daily_metrics?date=eq.${today}&limit=1`,
                    { headers }
                );
                const metrics = await metRes.json();
                currentData.metrics = metrics[0] || null;

                renderDashboard();
            } catch (e) {
                console.error('Fetch error:', e);
            }
        }

        function renderDashboard() {
            const tasks = currentData.tasks || [];
            const interventions = currentData.interventions || [];
            const activities = currentData.activities || [];
            const metrics = currentData.metrics;

            // Calculate stats
            const completed = tasks.filter(t => t.status === 'COMPLETED').length;
            const abandoned = tasks.filter(t => t.status === 'ABANDONED').length;
            const active = tasks.filter(t => !['COMPLETED', 'ABANDONED', 'DEFERRED'].includes(t.status)).length;
            const total = tasks.length;

            // Update quick stats
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-abandoned').textContent = abandoned;
            document.getElementById('stat-interventions').textContent = interventions.length;

            // Update productivity score
            const score = metrics?.productivity_score || (total > 0 ? Math.round((completed / total) * 100) : 0);
            updateProductivityRing(score);

            // Update ADHD metrics
            const focus = metrics?.average_focus_quality || 7;
            const energy = metrics?.energy_average || 7;
            const switches = metrics?.context_switches || 0;
            
            document.getElementById('focus-value').textContent = `${focus}/10`;
            document.getElementById('focus-bar').style.width = `${focus * 10}%`;
            document.getElementById('energy-value').textContent = `${energy}/10`;
            document.getElementById('energy-bar').style.width = `${energy * 10}%`;
            document.getElementById('switches-value').textContent = switches;

            // Domain breakdown
            const domains = { ARIEL: {c: 0, t: 0}, MICHAEL: {c: 0, t: 0}, FAMILY: {c: 0, t: 0}, BUSINESS: {c: 0, t: 0} };
            tasks.forEach(t => {
                const d = t.domain || 'ARIEL';
                if (domains[d]) {
                    domains[d].t++;
                    if (t.status === 'COMPLETED') domains[d].c++;
                }
            });
            
            document.getElementById('domain-ariel').textContent = `${domains.ARIEL.c}/${domains.ARIEL.t}`;
            document.getElementById('domain-michael').textContent = `${domains.MICHAEL.c}/${domains.MICHAEL.t}`;
            document.getElementById('domain-family').textContent = `${domains.FAMILY.c}/${domains.FAMILY.t}`;
            document.getElementById('domain-business').textContent = `${domains.BUSINESS.c}/${domains.BUSINESS.t}`;

            // Render active tasks
            const activeTasks = tasks.filter(t => !['COMPLETED', 'ABANDONED', 'DEFERRED'].includes(t.status));
            document.getElementById('active-count').textContent = `${activeTasks.length} tasks`;
            document.getElementById('active-tasks').innerHTML = activeTasks.length > 0 
                ? activeTasks.slice(0, 5).map(t => {
                    const statusColors = {
                        'INITIATED': 'bg-gray-600',
                        'SOLUTION_PROVIDED': 'bg-yellow-600',
                        'IN_PROGRESS': 'bg-blue-600'
                    };
                    const elapsed = t.initiated_at ? Math.round((Date.now() - new Date(t.initiated_at).getTime()) / 60000) : 0;
                    return `
                        <div class="flex items-center justify-between p-2 bg-gray-800/50 rounded-lg">
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-medium truncate">${t.description || 'Task'}</div>
                                <div class="text-xs text-gray-500">${t.domain} ‚Ä¢ ${elapsed}m elapsed</div>
                            </div>
                            <span class="status-badge ${statusColors[t.status] || 'bg-gray-600'} text-white ml-2">${t.status}</span>
                        </div>
                    `;
                }).join('')
                : '<div class="text-center text-gray-500 py-4 text-sm">No active tasks</div>';

            // Render timeline
            const timeline = [];
            tasks.forEach(t => {
                if (t.initiated_at) timeline.push({ time: t.initiated_at, type: 'START', desc: t.description, domain: t.domain });
                if (t.completed_at) timeline.push({ time: t.completed_at, type: 'DONE', desc: t.description });
                if (t.abandoned_at) timeline.push({ time: t.abandoned_at, type: 'ABANDONED', desc: t.description });
            });
            interventions.forEach(i => {
                if (i.triggered_at) timeline.push({ time: i.triggered_at, type: `INT_L${i.intervention_level}`, desc: i.task_description, level: i.intervention_level });
            });
            timeline.sort((a, b) => new Date(b.time) - new Date(a.time));

            document.getElementById('timeline-count').textContent = `${timeline.length} events`;
            document.getElementById('timeline').innerHTML = timeline.length > 0
                ? timeline.slice(0, 10).map(e => {
                    const time = new Date(e.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const icons = { START: 'üìù', DONE: '‚úÖ', ABANDONED: '‚ùå', INT_L1: 'üìå', INT_L2: 'üîÑ', INT_L3: '‚ö†Ô∏è' };
                    const colors = { START: 'text-blue-400', DONE: 'text-green-400', ABANDONED: 'text-red-400', INT_L1: 'text-yellow-400', INT_L2: 'text-orange-400', INT_L3: 'text-red-400' };
                    return `
                        <div class="relative pl-4">
                            <div class="timeline-dot"></div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500 w-12">${time}</span>
                                <span>${icons[e.type] || '‚Ä¢'}</span>
                                <span class="text-xs ${colors[e.type] || 'text-gray-400'} truncate flex-1">${e.desc?.substring(0, 30) || e.type}</span>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<div class="text-center text-gray-500 py-4 text-sm">No events yet</div>';

            // Render interventions
            document.getElementById('intervention-count').textContent = `${interventions.length} today`;
            document.getElementById('interventions-list').innerHTML = interventions.length > 0
                ? interventions.slice(0, 5).map(i => {
                    const levelColors = { 1: 'border-yellow-500', 2: 'border-orange-500', 3: 'border-red-500' };
                    return `
                        <div class="p-2 bg-gray-800/50 rounded-lg border-l-2 ${levelColors[i.intervention_level] || 'border-gray-500'}">
                            <div class="text-xs font-medium">L${i.intervention_level}: ${i.task_description?.substring(0, 25) || 'Task'}</div>
                            <div class="text-xs text-gray-500">${i.risk_level} risk ‚Ä¢ ${Math.round(i.abandonment_probability * 100)}% abandon prob</div>
                        </div>
                    `;
                }).join('')
                : '<div class="text-center text-gray-500 py-2 text-sm">No interventions</div>';

            // Check for active trip
            const tripActivity = activities.find(a => {
                try {
                    const notes = JSON.parse(a.notes || '{}');
                    return a.activity_type === 'DRIVING' && (notes.status === 'in_progress' || notes.status === 'scheduled');
                } catch { return false; }
            });

            if (tripActivity) {
                const trip = JSON.parse(tripActivity.notes || '{}');
                document.getElementById('trip-banner').classList.remove('hidden');
                document.getElementById('trip-title').textContent = trip.title || 'Active Trip';
                document.getElementById('trip-route').textContent = `${trip.origin || 'Home'} ‚Üí ${trip.destination || 'Destination'}${trip.departure_time ? ' ‚Ä¢ Depart: ' + trip.departure_time : ''}`;
                document.getElementById('trip-miles').textContent = trip.distance_miles || '--';
                
                const hours = Math.floor((trip.estimated_time_minutes || 0) / 60);
                const mins = (trip.estimated_time_minutes || 0) % 60;
                document.getElementById('trip-eta').textContent = `${hours}h${mins}m`;
                document.getElementById('trip-status').textContent = (trip.status || 'SCHEDULED').toUpperCase();

                document.getElementById('ariel-status').textContent = `‚Üí ${trip.destination || 'Traveling'}`;
                document.getElementById('michael-status').textContent = `‚Üí ${trip.destination || 'Traveling'}`;
            } else {
                document.getElementById('trip-banner').classList.add('hidden');
                document.getElementById('ariel-status').textContent = 'Home';
                document.getElementById('michael-status').textContent = 'Home';
            }

            // Check for swim meet
            const swimMeet = activities.find(a => a.activity_type === 'SWIM_MEET');
            if (swimMeet) {
                try {
                    const meet = JSON.parse(swimMeet.notes || '{}');
                    document.getElementById('events-list').innerHTML = `
                        <div class="p-2 bg-blue-900/30 rounded-lg">
                            <div class="text-xs font-medium text-blue-400">üèä ${meet.meet_name || 'Swim Meet'}</div>
                            <div class="text-xs text-gray-400">${meet.location || 'Location TBD'}</div>
                            <div class="text-xs text-gray-500 mt-1">${(meet.events || []).map(e => e.event).join(', ')}</div>
                        </div>
                    `;
                    document.getElementById('michael-status').textContent = `üèä ${meet.meet_name || 'Swim Meet'}`;
                } catch {}
            }

            // Show latest intervention alert
            if (interventions.length > 0) {
                const latest = interventions[0];
                const thirtyMinsAgo = Date.now() - 30 * 60 * 1000;
                if (new Date(latest.triggered_at).getTime() > thirtyMinsAgo) {
                    document.getElementById('intervention-banner').classList.remove('hidden');
                    document.getElementById('intervention-title').textContent = `Level ${latest.intervention_level} Intervention`;
                    document.getElementById('intervention-message').textContent = latest.message?.substring(0, 100) || 'Check your task';
                }
            }

            // Last cron
            const cronRun = activities.find(a => a.activity_type === 'CRON_RUN');
            if (cronRun) {
                const time = new Date(cronRun.start_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('last-cron').textContent = `Last sync: ${time}`;
            }
        }

        function dismissIntervention() {
            document.getElementById('intervention-banner').classList.add('hidden');
        }

        function shareFullStatus() {
            const tasks = currentData.tasks || [];
            const completed = tasks.filter(t => t.status === 'COMPLETED').length;
            const active = tasks.filter(t => !['COMPLETED', 'ABANDONED', 'DEFERRED'].includes(t.status)).length;
            
            const now = new Date();
            let msg = `üè† *Life OS Status Update*\n`;
            msg += `üìÖ ${now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })} ‚Ä¢ ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}\n\n`;
            msg += `üìä *Tasks:* ${completed}/${tasks.length} completed\n`;
            msg += `üîÑ *Active:* ${active} in progress\n`;
            msg += `üß† *Score:* ${currentData.metrics?.productivity_score || '--'}/100\n`;
            msg += `\n_Sent from Life OS_`;
            
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Initial fetch and auto-refresh
        fetchAllData();
        setInterval(fetchAllData, 30000);
    </script>
</body>
</html>
