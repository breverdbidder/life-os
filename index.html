<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life OS - Shapira Family Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --purple: #8b5cf6; --blue: #3b82f6; --green: #10b981; --orange: #f59e0b; --red: #ef4444; --whatsapp: #25D366; }
        body { background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f172a 100%); min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; }
        .glass { background: rgba(30, 30, 50, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(139, 92, 246, 0.2); }
        .glow { box-shadow: 0 0 25px rgba(139, 92, 246, 0.3); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .whatsapp-btn { background: #25D366; }
        .whatsapp-btn:hover { background: #128C7E; }
        .risk-high { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .risk-medium { background: rgba(245, 158, 11, 0.2); border-color: #f59e0b; }
        .risk-low { background: rgba(16, 185, 129, 0.2); border-color: #10b981; }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header with WhatsApp Share -->
        <div class="glass rounded-2xl p-5 mb-6 glow">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-5xl">ğŸ§ </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                            Life OS - Shapira Family
                        </h1>
                        <p class="text-gray-400 text-sm mt-1">ADHD Focus Tracking â€¢ Claude Performance â€¢ Task Management</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="shareStatus()" class="whatsapp-btn text-white px-4 py-2 rounded-xl flex items-center gap-2 font-semibold">
                        ğŸ“± Share
                    </button>
                    <div class="text-right">
                        <div id="current-date" class="text-lg font-semibold text-purple-400"></div>
                        <div id="current-time" class="text-2xl font-mono text-white"></div>
                        <div class="text-xs text-gray-500">ğŸ• FL: EST | IL: IST</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Focus Alert Banner -->
        <div id="focus-alert" class="hidden glass rounded-xl p-4 mb-6 border-2 border-red-500 bg-red-900/30">
            <div class="flex items-center gap-3">
                <span class="text-3xl pulse">âš ï¸</span>
                <div>
                    <div class="font-bold text-red-400">ADHD Intervention Required</div>
                    <div id="alert-message" class="text-sm text-gray-300">High-risk task needs attention</div>
                </div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="glass rounded-xl p-4 text-center">
                <div id="stat-total" class="text-3xl font-bold text-white">--</div>
                <div class="text-xs text-gray-400">Total Tasks</div>
            </div>
            <div class="glass rounded-xl p-4 text-center border border-green-500/30">
                <div id="stat-completed" class="text-3xl font-bold text-green-400">--</div>
                <div class="text-xs text-gray-400">Completed</div>
            </div>
            <div class="glass rounded-xl p-4 text-center border border-blue-500/30">
                <div id="stat-progress" class="text-3xl font-bold text-blue-400">--</div>
                <div class="text-xs text-gray-400">In Progress</div>
            </div>
            <div class="glass rounded-xl p-4 text-center border border-orange-500/30">
                <div id="stat-pending" class="text-3xl font-bold text-orange-400">--</div>
                <div class="text-xs text-gray-400">Pending</div>
            </div>
            <div class="glass rounded-xl p-4 text-center border border-red-500/30">
                <div id="stat-interventions" class="text-3xl font-bold text-red-400">--</div>
                <div class="text-xs text-gray-400">Open Alerts</div>
            </div>
        </div>

        <!-- Dual Score Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Ariel's Focus Score -->
            <div id="focus-score-card" class="glass rounded-2xl p-6 border border-purple-500/30">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ‘¤</span>
                    <h2 class="text-lg font-semibold text-purple-400">Ariel's Focus Score</h2>
                </div>
                <div class="flex items-center gap-6">
                    <div class="relative">
                        <div id="ariel-score-ring" class="w-24 h-24 rounded-full flex items-center justify-center" style="background: conic-gradient(from 0deg, #8b5cf6 0deg, rgba(255,255,255,0.1) 0deg);">
                            <div class="w-20 h-20 rounded-full bg-gray-900 flex flex-col items-center justify-center">
                                <span id="ariel-score" class="text-2xl font-bold text-white">--</span>
                                <span class="text-xs text-gray-400">/ 100</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="glass rounded-lg p-2 text-center">
                                <div id="ariel-tasks" class="text-lg font-bold text-green-400">--</div>
                                <div class="text-xs text-gray-500">Tasks Done</div>
                            </div>
                            <div class="glass rounded-lg p-2 text-center">
                                <div id="ariel-abandoned" class="text-lg font-bold text-red-400">--</div>
                                <div class="text-xs text-gray-500">Abandoned</div>
                            </div>
                            <div class="glass rounded-lg p-2 text-center">
                                <div id="ariel-rate" class="text-lg font-bold text-blue-400">--%</div>
                                <div class="text-xs text-gray-500">Rate</div>
                            </div>
                            <div class="glass rounded-lg p-2 text-center">
                                <div id="ariel-focus" class="text-lg font-bold text-purple-400">--</div>
                                <div class="text-xs text-gray-500">Focus</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="ariel-insight" class="mt-4 pt-3 border-t border-gray-700/50 text-sm text-gray-400">Loading...</div>
            </div>

            <!-- Claude's Performance Score -->
            <div id="claude-score-card" class="glass rounded-2xl p-6 border border-blue-500/30">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ¤–</span>
                    <h2 class="text-lg font-semibold text-blue-400">Claude's Performance</h2>
                </div>
                <div class="flex items-center gap-6">
                    <div class="relative">
                        <div id="claude-score-ring" class="w-24 h-24 rounded-full flex items-center justify-center" style="background: conic-gradient(from 0deg, #3b82f6 0deg, rgba(255,255,255,0.1) 0deg);">
                            <div class="w-20 h-20 rounded-full bg-gray-900 flex flex-col items-center justify-center">
                                <span id="claude-score" class="text-2xl font-bold text-white">--</span>
                                <span class="text-xs text-gray-400">/ 100</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="glass rounded-lg p-2 text-center">
                                <div id="claude-tools" class="text-lg font-bold text-green-400">--</div>
                                <div class="text-xs text-gray-500">Tool Calls</div>
                            </div>
                            <div class="glass rounded-lg p-2 text-center">
                                <div id="claude-files" class="text-lg font-bold text-purple-400">--</div>
                                <div class="text-xs text-gray-500">Files</div>
                            </div>
                            <div class="glass rounded-lg p-2 text-center">
                                <div id="claude-commits" class="text-lg font-bold text-blue-400">--</div>
                                <div class="text-xs text-gray-500">Commits</div>
                            </div>
                            <div class="glass rounded-lg p-2 text-center">
                                <div id="claude-errors" class="text-lg font-bold text-red-400">--</div>
                                <div class="text-xs text-gray-500">Errors</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="claude-insight" class="mt-4 pt-3 border-t border-gray-700/50 text-sm text-gray-400">Loading...</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Tasks List with Domain Filters -->
            <div class="lg:col-span-2 glass rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-purple-400">ğŸ“‹ Daily Tasks</h2>
                    <div class="flex gap-2" id="domain-filters">
                        <button onclick="filterTasks('all')" class="px-3 py-1 rounded-lg bg-purple-600 text-xs">All</button>
                        <button onclick="filterTasks('BUSINESS')" class="px-3 py-1 rounded-lg bg-gray-800 text-xs hover:bg-orange-600">ğŸ’¼ Business</button>
                        <button onclick="filterTasks('FAMILY')" class="px-3 py-1 rounded-lg bg-gray-800 text-xs hover:bg-green-600">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ Family</button>
                        <button onclick="filterTasks('MICHAEL')" class="px-3 py-1 rounded-lg bg-gray-800 text-xs hover:bg-blue-600">ğŸŠ Michael</button>
                        <button onclick="filterTasks('PERSONAL')" class="px-3 py-1 rounded-lg bg-gray-800 text-xs hover:bg-purple-600">ğŸ‘¤ Personal</button>
                    </div>
                </div>
                <div id="tasks-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-4">Loading tasks...</div>
                </div>
            </div>

            <!-- Domain Distribution Chart -->
            <div class="glass rounded-2xl p-5">
                <h2 class="text-lg font-semibold text-purple-400 mb-4">ğŸ“Š Tasks by Domain</h2>
                <canvas id="domain-chart" height="200"></canvas>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Weekly Trend -->
            <div class="glass rounded-2xl p-5">
                <h2 class="text-lg font-semibold text-purple-400 mb-4">ğŸ“ˆ Weekly Focus Trend</h2>
                <div style="height: 200px;"><canvas id="weeklyChart"></canvas></div>
            </div>

            <!-- Recent Insights -->
            <div class="glass rounded-2xl p-5">
                <h2 class="text-lg font-semibold text-purple-400 mb-4">ğŸ’¡ Recent Insights</h2>
                <div id="recent-insights" class="space-y-3 max-h-48 overflow-y-auto">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-600 text-xs py-4">
            Life OS v4.1 â€¢ Created by Ariel Shapira â€¢ Powered by Claude AI â€¢ Auto-refreshes every 30s
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mocerqjnksmhcjzxrewo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vY2VycWpua3NtaGNqenhyZXdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzI1MjYsImV4cCI6MjA4MDEwODUyNn0.ySFJIOngWWB0aqYra4PoGFuqcbdHOx1ZV6T9-klKQDw';
        const headers = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' };

        let allTasks = [];
        let currentFilter = 'all';
        let domainChart = null;
        let weeklyChart = null;

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Set score ring
        function setScoreRing(elementId, score, color) {
            const el = document.getElementById(elementId);
            if (el) el.style.background = `conic-gradient(from 0deg, ${color} ${score * 3.6}deg, rgba(255,255,255,0.1) ${score * 3.6}deg)`;
        }

        // Load Ariel's Focus Data
        async function loadArielData() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/daily_metrics?order=date.desc&limit=1`, { headers });
                const data = await res.json();
                if (data && data.length > 0) {
                    const d = data[0];
                    const score = d.productivity_score || 0;
                    document.getElementById('ariel-score').textContent = score;
                    document.getElementById('ariel-tasks').textContent = d.tasks_completed || 0;
                    document.getElementById('ariel-abandoned').textContent = d.tasks_abandoned || 0;
                    document.getElementById('ariel-rate').textContent = (d.completion_rate || 0) + '%';
                    document.getElementById('ariel-focus').textContent = (d.average_focus_quality || 0).toFixed(1);
                    setScoreRing('ariel-score-ring', score, score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444');
                    document.getElementById('ariel-insight').textContent = d.session_recommendation || `Date: ${d.date}`;
                }
            } catch (e) { console.error('Error loading Ariel data:', e); }
        }

        // Load Claude's Performance
        async function loadClaudeData() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/insights?insight_type=eq.claude_performance&order=id.desc&limit=1`, { headers });
                const data = await res.json();
                if (data && data.length > 0) {
                    const d = data[0];
                    const desc = d.description || '';
                    const scoreMatch = desc.match(/SCORE:\s*(\d+)/i);
                    const score = scoreMatch ? parseInt(scoreMatch[1]) : 0;
                    const toolsMatch = desc.match(/TOOL CALLS:\s*(\d+)/i);
                    const filesMatch = desc.match(/FILES CREATED:\s*(\d+)/i);
                    const commitsMatch = desc.match(/(\d+)\s*GitHub commit/i);
                    const errorsMatch = desc.match(/(\d+)\s*error/i);
                    document.getElementById('claude-score').textContent = score;
                    document.getElementById('claude-tools').textContent = toolsMatch ? toolsMatch[1] + '+' : '--';
                    document.getElementById('claude-files').textContent = filesMatch ? filesMatch[1] : '--';
                    document.getElementById('claude-commits').textContent = commitsMatch ? commitsMatch[1] : '--';
                    document.getElementById('claude-errors').textContent = errorsMatch ? errorsMatch[1] : '0';
                    setScoreRing('claude-score-ring', score, score >= 80 ? '#3b82f6' : score >= 60 ? '#f59e0b' : '#ef4444');
                    const achievements = desc.split('\n').filter(l => l.startsWith('âœ…')).slice(0, 2).join(' â€¢ ');
                    document.getElementById('claude-insight').textContent = achievements || d.title;
                }
            } catch (e) { console.error('Error loading Claude data:', e); }
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const res = await fetch(`${SUPABASE_URL}/rest/v1/task_states?select=*&order=initiated_at.desc`, { headers });
                const tasks = await res.json();
                allTasks = tasks;
                const todayTasks = tasks.filter(t => t.initiated_at?.startsWith(today));
                document.getElementById('stat-total').textContent = todayTasks.length;
                document.getElementById('stat-completed').textContent = todayTasks.filter(t => t.status === 'COMPLETED').length;
                document.getElementById('stat-progress').textContent = todayTasks.filter(t => t.status === 'IN_PROGRESS').length;
                document.getElementById('stat-pending').textContent = todayTasks.filter(t => ['INITIATED', 'SOLUTION_PROVIDED'].includes(t.status)).length;
                renderTasks();
                updateDomainChart(todayTasks);

                // Check interventions
                const intRes = await fetch(`${SUPABASE_URL}/rest/v1/task_interventions?successful=is.null&select=*&order=triggered_at.desc&limit=10`, { headers });
                const openInterventions = await intRes.json();
                document.getElementById('stat-interventions').textContent = openInterventions.length;
                const alertBanner = document.getElementById('focus-alert');
                const openHighRisk = openInterventions.find(i => i.intervention_level >= 3);
                if (openHighRisk) {
                    alertBanner.classList.remove('hidden');
                    document.getElementById('alert-message').textContent = openHighRisk.message || 'High-risk task needs attention';
                } else {
                    alertBanner.classList.add('hidden');
                }
            } catch (e) { console.error('Error loading tasks:', e); }
        }

        // Render Tasks
        function renderTasks() {
            const filtered = currentFilter === 'all' ? allTasks : allTasks.filter(t => t.domain === currentFilter);
            const container = document.getElementById('tasks-list');
            if (!filtered.length) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No tasks found</div>';
                return;
            }
            const domainIcons = { 'BUSINESS': 'ğŸ’¼', 'FAMILY': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦', 'MICHAEL': 'ğŸŠ', 'PERSONAL': 'ğŸ‘¤' };
            const statusColors = { 'COMPLETED': 'bg-green-900/50 border-green-500', 'IN_PROGRESS': 'bg-blue-900/50 border-blue-500', 'INITIATED': 'bg-gray-800 border-gray-600', 'SOLUTION_PROVIDED': 'bg-orange-900/50 border-orange-500', 'ABANDONED': 'bg-red-900/50 border-red-500' };
            container.innerHTML = filtered.slice(0, 20).map(t => `
                <div class="p-3 rounded-lg border ${statusColors[t.status] || 'bg-gray-800 border-gray-600'}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span>${domainIcons[t.domain] || 'ğŸ“Œ'}</span>
                            <span class="font-medium text-sm">${(t.description || t.task_id || 'Task').substring(0, 50)}</span>
                        </div>
                        <span class="status-badge ${t.status === 'COMPLETED' ? 'bg-green-600' : t.status === 'IN_PROGRESS' ? 'bg-blue-600' : 'bg-gray-600'}">${t.status}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Complexity: ${t.complexity || '-'} | ${t.domain || 'N/A'}</div>
                </div>
            `).join('');
        }

        // Filter Tasks
        function filterTasks(domain) {
            currentFilter = domain;
            document.querySelectorAll('#domain-filters button').forEach(btn => {
                btn.className = btn.className.replace(/bg-\w+-600/g, 'bg-gray-800');
            });
            event.target.className = event.target.className.replace('bg-gray-800', domain === 'all' ? 'bg-purple-600' : domain === 'BUSINESS' ? 'bg-orange-600' : domain === 'FAMILY' ? 'bg-green-600' : domain === 'MICHAEL' ? 'bg-blue-600' : 'bg-purple-600');
            renderTasks();
        }

        // Domain Chart
        function updateDomainChart(tasks) {
            const domains = { BUSINESS: 0, FAMILY: 0, MICHAEL: 0, PERSONAL: 0 };
            tasks.forEach(t => { if (domains[t.domain] !== undefined) domains[t.domain]++; });
            const ctx = document.getElementById('domain-chart');
            if (domainChart) domainChart.destroy();
            domainChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ğŸ’¼ Business', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ Family', 'ğŸŠ Michael', 'ğŸ‘¤ Personal'],
                    datasets: [{ data: [domains.BUSINESS, domains.FAMILY, domains.MICHAEL, domains.PERSONAL], backgroundColor: ['#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'], borderWidth: 0 }]
                },
                options: { plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af', font: { size: 10 } } } }, cutout: '60%' }
            });
        }

        // Weekly Chart
        async function loadWeeklyChart() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/daily_metrics?order=date.desc&limit=7`, { headers });
                const data = await res.json();
                const labels = data.map(d => d.date.split('-').slice(1).join('/')).reverse();
                const scores = data.map(d => d.productivity_score || 0).reverse();
                const ctx = document.getElementById('weeklyChart').getContext('2d');
                if (weeklyChart) weeklyChart.destroy();
                weeklyChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Focus Score', data: scores, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9ca3af' } }, x: { grid: { display: false }, ticks: { color: '#9ca3af' } } } }
                });
            } catch (e) { console.error('Error loading chart:', e); }
        }

        // Recent Insights
        async function loadInsights() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/insights?order=id.desc&limit=5`, { headers });
                const data = await res.json();
                const container = document.getElementById('recent-insights');
                if (data && data.length > 0) {
                    container.innerHTML = data.map(d => {
                        const icon = d.insight_type === 'claude_performance' ? 'ğŸ¤–' : d.insight_type === 'daily_focus' ? 'ğŸ¯' : d.insight_type === 'learning_session' ? 'ğŸ“š' : d.insight_type === 'deployment' ? 'ğŸš€' : 'ğŸ’¡';
                        return `<div class="flex items-start gap-3 p-3 rounded-lg bg-gray-800/50"><span class="text-xl">${icon}</span><div><div class="font-medium text-gray-200">${d.title}</div><div class="text-xs text-gray-500">${d.insight_type} â€¢ ${d.related_date || 'Today'}</div></div></div>`;
                    }).join('');
                }
            } catch (e) { console.error('Error loading insights:', e); }
        }

        // WhatsApp Share
        function shareStatus() {
            const completed = document.getElementById('stat-completed').textContent;
            const total = document.getElementById('stat-total').textContent;
            const arielScore = document.getElementById('ariel-score').textContent;
            const claudeScore = document.getElementById('claude-score').textContent;
            const msg = `ğŸ§  *Life OS Status Update*\nğŸ“… ${new Date().toLocaleDateString()}\n\nğŸ‘¤ Ariel Focus: ${arielScore}/100\nğŸ¤– Claude Score: ${claudeScore}/100\nâœ… ${completed}/${total} tasks completed\n\nğŸ”— https://breverdbidder.github.io/life-os/`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Initialize
        console.log("Life OS v4.1 loaded at", new Date().toISOString());
        loadArielData();
        loadClaudeData();
        loadTasks();
        loadWeeklyChart();
        loadInsights();
        setInterval(() => { loadArielData(); loadClaudeData(); loadTasks(); loadInsights(); }, 30000);
    </script>
</body>
</html>
