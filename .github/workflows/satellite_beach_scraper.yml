name: Satellite Beach + Rivals Scraper V5

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/satellite_beach_scraper.yml'

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright beautifulsoup4
          playwright install chromium
      
      - name: Scrape All Swimmers
        run: |
          python3 << 'PYTHON_EOF'
import asyncio
import json
import re
from datetime import datetime
from playwright.async_api import async_playwright
from bs4 import BeautifulSoup

SWIMMERS = [
    {"name": "Michael Shapira", "id": "3250085", "school": "Satellite Beach HS"},
    {"name": "Bastian Soto", "id": "2928537", "school": "Satellite Beach HS"},
    {"name": "Gavin Domboru", "id": "1518102", "school": "Satellite Beach HS"},
    {"name": "Max Morgan", "id": "2652914", "school": "Satellite Beach HS"},
    {"name": "Sawyer Davis", "id": "2662363", "school": "Satellite Beach HS"},
    {"name": "Aaron Gordon", "id": "1733035", "school": "Merritt Island HS"},
]

async def scrape_swimmer(page, swimmer_id, name):
    url = f"https://www.swimcloud.com/swimmer/{swimmer_id}/"
    print(f"\nScraping: {name} ({swimmer_id})")
    
    try:
        await page.goto(url, wait_until='networkidle', timeout=30000)
        await asyncio.sleep(2)
        
        content = await page.content()
        
        result = {"name": name, "swimcloud_id": swimmer_id, "events": {}}
        
        # Power Index
        pi_match = re.search(r'Power index\s*([\d.]+)', content)
        if pi_match:
            result["power_index"] = float(pi_match.group(1))
        
        # Florida Rank
        rank_match = re.search(r'Florida rank\s*(\d+)', content)
        if rank_match:
            result["fl_rank"] = int(rank_match.group(1))
        
        # Class
        class_match = re.search(r'Class\s*[·:]\s*(\d{4})', content)
        if class_match:
            result["class"] = int(class_match.group(1))
        
        # Extract times - multiple patterns
        patterns = [
            (r'50 Y Free[^0-9]*(\d{2}\.\d{2})', '50 Free'),
            (r'100 Y Free[^0-9]*(\d{2}\.\d{2})', '100 Free'),
            (r'200 Y Free[^0-9]*(1:\d{2}\.\d{2})', '200 Free'),
            (r'500 Y Free[^0-9]*([45]:\d{2}\.\d{2})', '500 Free'),
            (r'50 Y Back[^0-9]*(\d{2}\.\d{2})', '50 Back'),
            (r'100 Y Back[^0-9]*(\d{2}\.\d{2})', '100 Back'),
            (r'200 Y Back[^0-9]*(1:\d{2}\.\d{2})', '200 Back'),
            (r'50 Y Fly[^0-9]*(\d{2}\.\d{2})', '50 Fly'),
            (r'100 Y Fly[^0-9]*(\d{2}\.\d{2})', '100 Fly'),
            (r'50 Y Breast[^0-9]*(\d{2}\.\d{2})', '50 Breast'),
            (r'100 Y Breast[^0-9]*(1?:?\d{2}\.\d{2})', '100 Breast'),
            (r'200 Y IM[^0-9]*(1:\d{2}\.\d{2})', '200 IM'),
            (r'100 Free[^0-9–-]*[–-]\s*(\d{2}\.\d{2})', '100 Free'),
            (r'100 Back[^0-9–-]*[–-]\s*(\d{2}\.\d{2})', '100 Back'),
        ]
        
        for pattern, event in patterns:
            if event not in result["events"]:
                matches = re.findall(pattern, content, re.IGNORECASE)
                if matches:
                    # Get best time
                    times = []
                    for m in matches:
                        try:
                            if ':' in m:
                                parts = m.split(':')
                                secs = float(parts[0]) * 60 + float(parts[1])
                            else:
                                secs = float(m)
                            if 15 < secs < 600:
                                times.append((secs, m))
                        except:
                            pass
                    if times:
                        best = min(times, key=lambda x: x[0])
                        result["events"][event] = best[1]
        
        print(f"  PI: {result.get('power_index', 'N/A')} | Rank: {result.get('fl_rank', 'N/A')} | Events: {len(result['events'])}")
        for e, t in sorted(result["events"].items()):
            print(f"    {e}: {t}")
        
        return result
        
    except Exception as e:
        print(f"  ERROR: {e}")
        return {"name": name, "swimcloud_id": swimmer_id, "error": str(e)}

async def main():
    print("="*60)
    print("SATELLITE BEACH + RIVALS SCRAPER V5")
    print("="*60)
    
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        context = await browser.new_context(
            user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        )
        page = await context.new_page()
        
        results = []
        for swimmer in SWIMMERS:
            result = await scrape_swimmer(page, swimmer["id"], swimmer["name"])
            result["school"] = swimmer["school"]
            results.append(result)
            await asyncio.sleep(1)
        
        await browser.close()
    
    output = {
        "version": "V5_WITH_AARON_GORDON",
        "scraped_at": datetime.now().isoformat(),
        "swimmers": results
    }
    
    with open("swimmers_with_gordon.json", "w") as f:
        json.dump(output, f, indent=2)
    
    print(f"\n{'='*60}")
    print(f"COMPLETE: {len(results)} swimmers scraped")
    print(f"{'='*60}")

asyncio.run(main())
PYTHON_EOF
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: swimmers-v5-${{ github.run_number }}
          path: swimmers_with_gordon.json
      
      - name: Commit to Repo
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          mkdir -p michael_d1_agents_v3/data
          cp swimmers_with_gordon.json michael_d1_agents_v3/data/
          git add michael_d1_agents_v3/data/swimmers_with_gordon.json
          git diff --staged --quiet || git commit -m "data: swimmers V5 with Aaron Gordon $(date +'%Y-%m-%d %H:%M')"
          git push || echo "Nothing to push"
