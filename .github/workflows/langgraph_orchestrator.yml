name: Michael D1 LangGraph Orchestrator

on:
  schedule:
    # Run at 6 AM EST daily for pre-meet prep (72-hour window)
    - cron: '0 11 * * *'
    # Run at 8 PM EST for daily summary
    - cron: '0 1 * * *'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - scrape_competitor_pbs
          - generate_meet_prep
          - update_uf_progress
          - full_orchestration
      swimmers:
        description: 'Comma-separated swimmer names (for scraping)'
        required: false
        default: 'Bastian Soto,Aaron Gordon'
      events:
        description: 'Comma-separated events'
        required: false
        default: '100 Free,50 Free,100 Fly'
      meet_name:
        description: 'Meet name (for prep generation)'
        required: false
        default: 'Harry Meisel Championships'

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install supabase httpx
      
      - name: Run Orchestrator
        run: |
          cd michael_d1_agents_v2
          python3 << 'EOF'
          import os
          import sys
          import json
          from datetime import datetime, date, timedelta
          
          # Import orchestrator
          from orchestrator_v2_integrated import MichaelD1OrchestratorV2Integrated
          
          action = os.environ.get('INPUT_ACTION', 'full_orchestration')
          swimmers = os.environ.get('INPUT_SWIMMERS', 'Bastian Soto,Aaron Gordon').split(',')
          events = os.environ.get('INPUT_EVENTS', '100 Free,50 Free,100 Fly').split(',')
          meet_name = os.environ.get('INPUT_MEET_NAME', 'Harry Meisel Championships')
          
          print(f"ðŸŠ Michael D1 LangGraph Orchestrator")
          print(f"=" * 60)
          print(f"   Action: {action}")
          print(f"   Swimmers: {swimmers}")
          print(f"   Events: {events}")
          print(f"=" * 60)
          
          orchestrator = MichaelD1OrchestratorV2Integrated()
          
          if action == 'scrape_competitor_pbs':
              print("\nðŸ“Š Scraping Competitor PBs...")
              result = orchestrator.scrape_all_competitors()
              print(f"   Swimmers scraped: {result.get('swimmers_scraped', 0)}")
              print(f"   Events: {result.get('events_scraped', 0)}")
              
          elif action == 'generate_meet_prep':
              print(f"\nðŸ“„ Generating Meet Prep for {meet_name}...")
              doc = orchestrator.generate_meet_prep_document(
                  meet_name,
                  date.today() + timedelta(days=1),
                  [e.strip() for e in events],
                  [s.strip() for s in swimmers]
              )
              # Save to file
              filename = f"meet_prep_{date.today().isoformat()}.md"
              with open(filename, 'w') as f:
                  f.write(doc)
              print(f"   âœ… Document saved: {filename}")
              
          elif action == 'update_uf_progress':
              print("\nðŸŽ¯ Updating UF 2027 Progress...")
              result = orchestrator.agents['goals'].process("", {})
              print(f"   Target: {result.get('target')}")
              for event, gap in result.get('current_gaps', {}).items():
                  print(f"   {event}: {gap}s gap")
                  
          elif action == 'full_orchestration':
              print("\nðŸš€ Running Full Orchestration...")
              
              # 1. Scrape competitors
              print("\n   Step 1: Scraping competitor PBs...")
              scrape = orchestrator.scrape_all_competitors()
              print(f"      âœ… {scrape.get('swimmers_scraped', 0)} swimmers scraped")
              
              # 2. Check for upcoming meets (within 72 hours)
              print("\n   Step 2: Checking upcoming meets...")
              schedule = orchestrator.agents['events_schedule'].process("", {})
              upcoming = schedule.get('upcoming_meets', [])
              print(f"      Found {len(upcoming)} upcoming meets")
              
              # 3. Generate prep docs for meets within 72 hours
              for meet in upcoming:
                  meet_date_str = meet.get('date', '')
                  if meet_date_str:
                      meet_date = datetime.strptime(meet_date_str, '%Y-%m-%d').date()
                      days_until = (meet_date - date.today()).days
                      if 0 <= days_until <= 3:
                          print(f"\n   Step 3: Generating prep for {meet.get('name')} ({days_until} days away)...")
                          doc = orchestrator.generate_meet_prep_document(
                              meet.get('name'),
                              meet_date,
                              events,
                              swimmers
                          )
                          filename = f"meet_prep_{meet.get('name').replace(' ', '_')}_{meet_date}.md"
                          with open(filename, 'w') as f:
                              f.write(doc)
                          print(f"      âœ… {filename}")
              
              # 4. Update progress tracking
              print("\n   Step 4: Updating UF progress...")
              goals = orchestrator.agents['goals'].process("", {})
              print(f"      Closest event: {goals.get('closest_event')}")
          
          print("\n" + "=" * 60)
          print("âœ… Orchestration Complete")
          print("=" * 60)
          EOF
      
      - name: Log to Supabase
        if: always()
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime
          try:
              from supabase import create_client
              url = os.environ.get('SUPABASE_URL')
              key = os.environ.get('SUPABASE_KEY')
              if url and key:
                  client = create_client(url, key)
                  client.table('insights').insert({
                      'category': 'michael_swim',
                      'content': f"LangGraph Orchestrator run: {os.environ.get('INPUT_ACTION', 'full_orchestration')}",
                      'metadata': {
                          'action': os.environ.get('INPUT_ACTION', 'full_orchestration'),
                          'timestamp': datetime.now().isoformat(),
                          'workflow': 'langgraph_orchestrator'
                      }
                  }).execute()
                  print("âœ… Logged to Supabase")
          except Exception as e:
              print(f"âš ï¸ Supabase logging: {e}")
          EOF
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: meet-prep-docs
          path: michael_d1_agents_v2/*.md
          if-no-files-found: ignore
