name: SwimCloud Scraper

on:
  workflow_dispatch:
    inputs:
      swimmer_id:
        description: 'Specific swimmer ID to scrape (optional)'
        required: false
        default: '3250085'  # Michael Shapira
      scrape_team:
        description: 'Also scrape team roster'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  scrape-swimcloud:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Run SwimCloud Scraper
        run: |
          python scripts/swimcloud_scraper.py
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: swimcloud-results-${{ github.run_id }}
          path: swimcloud_results.json
      
      - name: Display results
        run: |
          echo "=== SwimCloud Scrape Results ==="
          cat swimcloud_results.json | python3 -m json.tool
      
      - name: Insert to Supabase
        if: success()
        run: |
          python3 << 'EOF'
          import json
          import requests
          import os
          
          SUPABASE_URL = os.environ.get("SUPABASE_URL")
          SUPABASE_KEY = os.environ.get("SUPABASE_KEY")
          
          with open("swimcloud_results.json") as f:
              data = json.load(f)
          
          # Insert each swimmer's data as an insight
          for swimmer in data.get("swimmers", []):
              insight = {
                  "insight_type": "michael_swim",
                  "title": f"SwimCloud Times: {swimmer['name']}",
                  "description": json.dumps(swimmer.get("times", [])),
                  "source": "swimcloud_scraper"
              }
              
              response = requests.post(
                  f"{SUPABASE_URL}/rest/v1/insights",
                  headers={
                      "apikey": SUPABASE_KEY,
                      "Authorization": f"Bearer {SUPABASE_KEY}",
                      "Content-Type": "application/json"
                  },
                  json=insight
              )
              
              if response.status_code in [200, 201]:
                  print(f"✅ Saved {swimmer['name']} to Supabase")
              else:
                  print(f"❌ Failed to save {swimmer['name']}: {response.status_code}")
          EOF
