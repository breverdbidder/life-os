name: RealTDM Title Search V2

on:
  workflow_dispatch:
    inputs:
      sale_date:
        description: 'Sale date MM/DD/YYYY'
        required: true
        default: '12/18/2025'
  schedule:
    - cron: '0 6 * * 3'  # Every Wednesday at 6 AM

jobs:
  title_search:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Scrape RealTDM
        env:
          SALE_DATE: ${{ github.event.inputs.sale_date || '12/18/2025' }}
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');
          
          const BASE_URL = 'https://brevard.realtdm.com';
          const USERNAME = 'Everest8';
          const PASSWORD = 'Everest18$';
          const SALE_DATE = process.env.SALE_DATE;
          
          (async () => {
            console.log('=== RealTDM Title Search ===');
            console.log('Sale Date:', SALE_DATE);
            
            const browser = await chromium.launch({ headless: true, args: ['--no-sandbox'] });
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0'
            });
            
            const page = await context.newPage();
            const results = { sale_date: SALE_DATE, cases: [] };
            
            try {
              // Login
              console.log('Logging in...');
              await page.goto(BASE_URL, { waitUntil: 'networkidle', timeout: 60000 });
              await page.fill('input[name="username"]', USERNAME);
              await page.fill('input[name="password"]', PASSWORD);
              await page.screenshot({ path: 'login.png' });
              
              const btn = await page.$('input[type="submit"]');
              if (btn) await btn.click();
              await page.waitForTimeout(3000);
              await page.screenshot({ path: 'after_login.png' });
              
              // Get cases
              console.log('Getting cases...');
              await page.goto(BASE_URL + '/public/cases/list', { waitUntil: 'networkidle' });
              
              const start = await page.$('#filterSaleDateStart');
              const end = await page.$('#filterSaleDateStop');
              if (start && end) {
                await start.fill(SALE_DATE);
                await end.fill(SALE_DATE);
                const filterBtn = await page.$('.btn-search');
                if (filterBtn) await filterBtn.click();
                await page.waitForTimeout(2000);
              }
              await page.screenshot({ path: 'cases.png' });
              
              // Extract
              const rows = await page.$$('tr.load-case[data-caseid]');
              console.log('Found', rows.length, 'cases');
              
              for (const row of rows) {
                const id = await row.getAttribute('data-caseid');
                const cells = await row.$$('td');
                if (cells.length >= 7) {
                  results.cases.push({
                    case_id: id,
                    case_number: await cells[2].innerText(),
                    parcel_id: await cells[5].innerText(),
                    sale_date: await cells[6].innerText()
                  });
                }
              }
              
              // Get details
              for (let i = 0; i < results.cases.length; i++) {
                const c = results.cases[i];
                console.log('Getting details for case', c.case_number);
                try {
                  const row = await page.$('tr[data-caseid="' + c.case_id + '"]');
                  if (row) {
                    await row.click();
                    await page.waitForTimeout(2000);
                    await page.screenshot({ path: 'case_' + c.case_id + '.png' });
                    
                    const html = await page.content();
                    
                    const cert = html.match(/Certificate\s*#?\s*:?\s*([\d-]+)/i);
                    if (cert) c.certificate_number = cert[1];
                    
                    const face = html.match(/Face\s*(?:Amount)?\s*:?\s*\$?([\d,\.]+)/i);
                    if (face) c.face_amount = face[1];
                    
                    const rate = html.match(/Interest\s*:?\s*([\d\.]+)\s*%/i);
                    if (rate) c.interest_rate = rate[1] + '%';
                    
                    const holder = html.match(/Holder\s*:?\s*([A-Za-z][^<\n]{2,50})/i);
                    if (holder) c.certificate_holder = holder[1].trim();
                    
                    console.log('  Cert:', c.certificate_number || 'N/A', '| Face:', c.face_amount || 'N/A');
                    
                    const close = await page.$('.close, [data-dismiss="modal"]');
                    if (close) await close.click();
                    else await page.goBack();
                    await page.waitForTimeout(1000);
                  }
                } catch (e) {
                  console.log('  Error:', e.message.substring(0,50));
                }
              }
              
            } catch (e) {
              console.error('Error:', e.message);
              results.error = e.message;
              await page.screenshot({ path: 'error.png' });
            }
            
            await browser.close();
            fs.writeFileSync('results.json', JSON.stringify(results, null, 2));
            console.log('Done! Cases:', results.cases.length);
          })();
          EOF

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: title-search-${{ github.run_id }}
          path: |
            *.png
            *.json
          retention-days: 30

      - name: Display Results
        run: cat results.json
