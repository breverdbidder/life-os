name: üì∫ YouTube Transcript V5 (Bernardo Actor)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube URL'
        required: true
        default: 'https://youtube.com/shorts/C2Dl6P7diHw'

env:
  SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co

jobs:
  transcribe:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üì¶ Install
        run: pip install requests
          
      - name: üì∫ Apify Transcription
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          APIFY_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          python3 << 'PYEOF'
          import os, re, json, time, requests
          from datetime import datetime, timezone
          
          video_url = os.environ['VIDEO_URL']
          apify_token = os.environ['APIFY_TOKEN']
          supabase_key = os.environ.get('SUPABASE_KEY', '')
          supabase_url = os.environ.get('SUPABASE_URL', '')
          
          # Extract video ID
          patterns = [r'shorts/([a-zA-Z0-9_-]{11})', r'v=([a-zA-Z0-9_-]{11})', r'youtu\.be/([a-zA-Z0-9_-]{11})']
          video_id = None
          for p in patterns:
              m = re.search(p, video_url)
              if m:
                  video_id = m.group(1)
                  break
          
          if not video_id:
              print("‚ùå Invalid URL")
              exit(1)
          
          print(f"üì∫ Video ID: {video_id}")
          
          # Try different Apify actors
          actors = [
              ("bernardo~youtube-transcript-scraper", {"videoUrls": [f"https://www.youtube.com/watch?v={video_id}"]}),
              ("streamers~youtube-scraper", {"startUrls": [{"url": f"https://www.youtube.com/watch?v={video_id}"}], "subtitlesLanguage": "en", "maxResults": 1}),
          ]
          
          for actor_name, payload in actors:
              print(f"\nüöÄ Trying: {actor_name}")
              run_url = f"https://api.apify.com/v2/acts/{actor_name}/runs?token={apify_token}"
              
              try:
                  resp = requests.post(run_url, json=payload, timeout=30)
                  print(f"   Response: {resp.status_code}")
                  
                  if resp.status_code == 201:
                      run_data = resp.json()['data']
                      run_id = run_data['id']
                      dataset_id = run_data['defaultDatasetId']
                      print(f"   Run ID: {run_id}")
                      
                      # Wait for completion
                      for i in range(24):
                          time.sleep(5)
                          status_resp = requests.get(f"https://api.apify.com/v2/actor-runs/{run_id}?token={apify_token}")
                          status = status_resp.json()['data']['status']
                          print(f"   [{i*5}s] {status}")
                          
                          if status == 'SUCCEEDED':
                              # Get results
                              dataset_resp = requests.get(f"https://api.apify.com/v2/datasets/{dataset_id}/items?token={apify_token}")
                              results = dataset_resp.json()
                              print(f"   Results: {len(results)} items")
                              
                              if results:
                                  item = results[0]
                                  print(f"   Keys: {list(item.keys())}")
                                  
                                  # Try to find transcript
                                  transcript = item.get('transcript') or item.get('subtitles') or item.get('text') or ''
                                  if isinstance(transcript, list):
                                      transcript = ' '.join([t.get('text','') for t in transcript])
                                  
                                  title = item.get('title') or item.get('videoTitle') or 'Unknown'
                                  channel = item.get('channel') or item.get('channelName') or 'Unknown'
                                  
                                  if transcript and len(transcript) > 20:
                                      print(f"\n{'='*60}")
                                      print(f"üìù Title: {title}")
                                      print(f"üì∫ Channel: {channel}")
                                      print(f"{'='*60}")
                                      print(f"TRANSCRIPT:\n{transcript}")
                                      print(f"{'='*60}")
                                      print(f"‚úÖ {len(transcript)} chars | {len(transcript.split())} words")
                                      
                                      # Save
                                      output = {
                                          "video_id": video_id,
                                          "video_url": video_url,
                                          "title": title,
                                          "channel": channel,
                                          "transcript": transcript,
                                          "transcript_source": f"apify:{actor_name}",
                                          "extracted_at": datetime.now(timezone.utc).isoformat()
                                      }
                                      
                                      with open('transcript.json', 'w') as f:
                                          json.dump(output, f, indent=2)
                                      
                                      # Supabase
                                      if supabase_key:
                                          headers = {"apikey": supabase_key, "Authorization": f"Bearer {supabase_key}", "Content-Type": "application/json"}
                                          insight = {"user_id": 1, "insight_type": "youtube_transcript", "title": f"üì∫ {title[:80]}",
                                                    "content": transcript[:10000], "category": "research", "source": "apify", "priority": 2, "status": "Active"}
                                          requests.post(f"{supabase_url}/rest/v1/insights", headers=headers, json=insight, timeout=10)
                                          print("‚úÖ Saved to Supabase")
                                      
                                      exit(0)
                              break
                          elif status in ['FAILED', 'ABORTED', 'TIMED-OUT']:
                              print(f"   ‚ö†Ô∏è {status}")
                              break
                  else:
                      print(f"   Body: {resp.text[:200]}")
              except Exception as e:
                  print(f"   Error: {e}")
          
          print("‚ùå All actors failed")
          exit(1)
          PYEOF
          
      - name: üì§ Upload
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: transcript-v5
          path: transcript.json
          if-no-files-found: ignore
