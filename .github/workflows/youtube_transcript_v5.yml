name: "üì∫ YouTube Transcript Agent V5"

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube URL (video, short, live, playlist item)'
        required: true
        type: string
      category:
        description: 'Category for Supabase logging'
        required: false
        default: 'learning'
        type: string
      whisper_model:
        description: 'Whisper model (tiny, base, small, medium)'
        required: false
        default: 'base'
        type: string

env:
  SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co

jobs:
  extract-transcript:
    name: "üé¨ Extract YouTube Transcript V5"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "üì¶ Install Dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install youtube-transcript-api yt-dlp httpx requests webvtt-py
          pip install --upgrade yt-dlp
          pip install openai-whisper

      - name: "üé¨ Extract Transcript V5"
        env:
          VIDEO_URL: ${{ inputs.video_url }}
          WHISPER_MODEL: ${{ inputs.whisper_model }}
          CATEGORY: ${{ inputs.category }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
          LOG_TO_SUPABASE: 'true'
        run: |
          python3 << 'EOF'
          import os, re, json, subprocess, glob, time
          
          video_url = os.environ.get('VIDEO_URL', '')
          whisper_model = os.environ.get('WHISPER_MODEL', 'base')
          category = os.environ.get('CATEGORY', 'learning')
          supabase_key = os.environ.get('SUPABASE_KEY', '')
          apify_token = os.environ.get('APIFY_TOKEN', '')
          log_to_supabase = os.environ.get('LOG_TO_SUPABASE', 'false').lower() == 'true'
          supabase_url = os.environ.get('SUPABASE_URL', '')
          
          print(f"=" * 70)
          print(f"üì∫ YOUTUBE TRANSCRIPT AGENT V5 - LIFE OS")
          print(f"=" * 70)
          print(f"URL: {video_url}")
          print(f"Category: {category}")
          print(f"Whisper Model: {whisper_model}")
          
          # Extract video ID
          def extract_video_id(url):
              patterns = [
                  r'(?:youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})',
                  r'(?:youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})',
                  r'(?:youtu\.be\/)([a-zA-Z0-9_-]{11})',
                  r'(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})',
                  r'(?:youtube\.com\/live\/)([a-zA-Z0-9_-]{11})',
              ]
              for pattern in patterns:
                  match = re.search(pattern, url)
                  if match:
                      return match.group(1)
              return None
          
          video_id = extract_video_id(video_url)
          if not video_id:
              print("‚ùå Could not extract video ID")
              exit(1)
          
          video_type = "short" if "/shorts/" in video_url else "regular"
          print(f"\nüì∫ Video ID: {video_id}")
          print(f"üìå Type: {video_type}")
          
          transcript = ""
          transcript_source = "none"
          language = "unknown"
          metadata = {"title": "Unknown", "channel": "Unknown", "duration": 0}
          
          # =================================================================
          # STRATEGY 1: YouTube Transcript API (FREE)
          # =================================================================
          print(f"\n{'='*50}")
          print(f"üéØ STRATEGY 1: YouTube Transcript API (FREE)")
          print(f"{'='*50}")
          
          try:
              from youtube_transcript_api import YouTubeTranscriptApi
              ytt_api = YouTubeTranscriptApi()
              result = ytt_api.fetch(video_id)
              transcript = " ".join([item.text for item in result.snippets])
              language = result.language_code
              transcript_source = "youtube_transcript_api"
              print(f"‚úÖ Strategy 1 SUCCESS - {len(transcript)} chars")
          except Exception as e:
              print(f"‚ö†Ô∏è Strategy 1 failed: {type(e).__name__}: {str(e)[:100]}")
          
          # =================================================================
          # STRATEGY 2: yt-dlp Subtitle Download (FREE)
          # =================================================================
          if not transcript or len(transcript) < 50:
              print(f"\n{'='*50}")
              print(f"üéØ STRATEGY 2: yt-dlp Subtitle Download (FREE)")
              print(f"{'='*50}")
              
              try:
                  cmd = [
                      'yt-dlp',
                      '--write-auto-sub',
                      '--sub-lang', 'en',
                      '--skip-download',
                      '-o', 'transcript',
                      '--no-check-certificates',
                      f'https://www.youtube.com/watch?v={video_id}'
                  ]
                  subprocess.run(cmd, capture_output=True, timeout=60)
                  
                  sub_files = glob.glob('transcript*.vtt') + glob.glob('transcript*.srt')
                  if sub_files:
                      with open(sub_files[0], 'r', encoding='utf-8') as f:
                          content = f.read()
                      lines = [l.strip() for l in content.split('\n') 
                               if l.strip() and not l.strip().startswith(('WEBVTT', '00:', 'NOTE'))]
                      transcript = " ".join(lines)
                      transcript_source = "yt_dlp_subtitles"
                      language = "en"
                      print(f"‚úÖ Strategy 2 SUCCESS - {len(transcript)} chars")
                  else:
                      print("‚ö†Ô∏è No subtitle files found")
              except Exception as e:
                  print(f"‚ö†Ô∏è Strategy 2 failed: {e}")
          
          # =================================================================
          # STRATEGY 3: Whisper Transcription (FREE - Local) - IMPROVED
          # =================================================================
          if not transcript or len(transcript) < 50:
              print(f"\n{'='*50}")
              print(f"üéØ STRATEGY 3: Whisper Transcription ({whisper_model})")
              print(f"{'='*50}")
              
              try:
                  print("üîä Downloading audio with yt-dlp...")
                  
                  # More robust yt-dlp command with cookies and headers
                  cmd = [
                      'yt-dlp',
                      '-x',
                      '--audio-format', 'mp3',
                      '--audio-quality', '0',
                      '-o', 'audio.%(ext)s',
                      '--no-check-certificates',
                      '--no-warnings',
                      '--extractor-args', 'youtube:player_client=android',
                      '--user-agent', 'Mozilla/5.0 (Linux; Android 10; SM-G960F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.120 Mobile Safari/537.36',
                      '-v',
                      f'https://www.youtube.com/watch?v={video_id}'
                  ]
                  result = subprocess.run(cmd, capture_output=True, text=True, timeout=180)
                  print(f"yt-dlp stdout: {result.stdout[-500:] if result.stdout else 'empty'}")
                  print(f"yt-dlp stderr: {result.stderr[-500:] if result.stderr else 'empty'}")
                  
                  audio_files = glob.glob('audio.*')
                  print(f"Audio files found: {audio_files}")
                  
                  if audio_files:
                      import whisper
                      print(f"üéôÔ∏è Transcribing with Whisper {whisper_model}...")
                      model = whisper.load_model(whisper_model)
                      result = model.transcribe(audio_files[0])
                      transcript = result.get("text", "")
                      language = result.get("language", "en")
                      transcript_source = f"whisper_{whisper_model}"
                      print(f"‚úÖ Strategy 3 SUCCESS - {len(transcript)} chars")
                  else:
                      print("‚ö†Ô∏è Audio download failed - no files created")
              except Exception as e:
                  print(f"‚ö†Ô∏è Strategy 3 failed: {type(e).__name__}: {e}")
          
          # =================================================================
          # STRATEGY 4: Apify YouTube Transcript (PAID FALLBACK)
          # =================================================================
          if (not transcript or len(transcript) < 50) and apify_token:
              print(f"\n{'='*50}")
              print(f"üéØ STRATEGY 4: Apify Whisper Transcription (PAID)")
              print(f"{'='*50}")
              
              try:
                  import httpx
                  # Use the Whisper-based scraper for videos without subtitles
                  actor_id = "fastcrawler~youtube-transcript-scraper-for-videos-without-subtitles-2025"
                  
                  run_url = f"https://api.apify.com/v2/acts/{actor_id}/runs"
                  headers = {"Authorization": f"Bearer {apify_token}"}
                  payload = {
                      "startUrls": [{"url": video_url}],
                      "maxVideos": 1
                  }
                  
                  print(f"üöÄ Triggering Apify actor: {actor_id}")
                  response = httpx.post(run_url, json=payload, headers=headers, timeout=30)
                  
                  if response.status_code == 201:
                      run_data = response.json()
                      run_id = run_data.get("data", {}).get("id")
                      print(f"üìå Run ID: {run_id}")
                      
                      # Poll for completion
                      for i in range(30):
                          time.sleep(10)
                          status_url = f"https://api.apify.com/v2/actor-runs/{run_id}"
                          status_resp = httpx.get(status_url, headers=headers, timeout=30)
                          status = status_resp.json().get("data", {}).get("status")
                          print(f"   Status: {status}")
                          if status == "SUCCEEDED":
                              # Get results
                              results_url = f"https://api.apify.com/v2/actor-runs/{run_id}/dataset/items"
                              results_resp = httpx.get(results_url, headers=headers, timeout=30)
                              items = results_resp.json()
                              if items and len(items) > 0:
                                  transcript = items[0].get("transcript", "")
                                  transcript_source = "apify_whisper"
                                  language = "en"
                                  print(f"‚úÖ Strategy 4 SUCCESS - {len(transcript)} chars")
                              break
                          elif status in ["FAILED", "ABORTED"]:
                              print(f"‚ö†Ô∏è Apify run failed: {status}")
                              break
                  else:
                      print(f"‚ö†Ô∏è Apify API error: {response.status_code}")
              except Exception as e:
                  print(f"‚ö†Ô∏è Strategy 4 failed: {e}")
          
          # =================================================================
          # FINAL OUTPUT
          # =================================================================
          if not transcript or len(transcript) < 50:
              transcript = "Transcript unavailable - video may not have captions"
              transcript_source = "failed"
          
          print(f"\n{'='*70}")
          print(f"üìä FINAL RESULT")
          print(f"{'='*70}")
          print(f"   Source: {transcript_source}")
          print(f"   Language: {language}")
          print(f"   Characters: {len(transcript)}")
          print(f"   Words: {len(transcript.split())}")
          print(f"\nüìù FULL TRANSCRIPT:")
          print(f"-" * 50)
          print(transcript[:5000])
          
          # Save to JSON
          output = {
              "video_id": video_id,
              "video_url": video_url,
              "video_type": video_type,
              "transcript": transcript,
              "transcript_source": transcript_source,
              "language": language,
              "metadata": metadata,
              "category": category,
              "timestamp": time.strftime("%Y-%m-%dT%H:%M:%SZ")
          }
          
          with open("transcript.json", "w") as f:
              json.dump(output, f, indent=2)
          
          print(f"\nüíæ Saved to transcript.json")
          
          # Log to Supabase
          if log_to_supabase and supabase_key and transcript_source != "failed":
              try:
                  import httpx
                  insight = {
                      "title": f"YouTube: {video_id}",
                      "content": transcript[:10000],
                      "category": category,
                      "metadata": {
                          "video_id": video_id,
                          "video_url": video_url,
                          "transcript_source": transcript_source,
                          "language": language,
                          "word_count": len(transcript.split())
                      }
                  }
                  headers = {
                      "apikey": supabase_key,
                      "Authorization": f"Bearer {supabase_key}",
                      "Content-Type": "application/json"
                  }
                  resp = httpx.post(f"{supabase_url}/rest/v1/insights", json=insight, headers=headers, timeout=30)
                  if resp.status_code in [200, 201]:
                      print(f"‚úÖ Supabase logged successfully")
                  else:
                      print(f"‚ö†Ô∏è Supabase error: {resp.status_code}")
              except Exception as e:
                  print(f"‚ö†Ô∏è Supabase logging failed: {e}")
          
          print(f"\n‚úÖ YouTube Transcript Agent V5 Complete!")
          EOF

      - name: "üì§ Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: transcript-${{ inputs.video_url && 'video' || 'unknown' }}
          path: transcript.json
          retention-days: 90

      - name: "üìä Summary"
        run: |
          echo "## üì∫ YouTube Transcript Agent V5 Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Video URL:** ${{ inputs.video_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Whisper Model:** ${{ inputs.whisper_model }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f transcript.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat transcript.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
