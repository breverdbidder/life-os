name: Run SQL Migration

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to run (in migrations/ folder)'
        required: false
        default: '001_create_focus_scores.sql'

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install psql
        run: sudo apt-get install -y postgresql-client
        
      - name: Run Migration
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          if [ -n "$SUPABASE_DB_URL" ]; then
            echo "Running migration via psql..."
            psql "$SUPABASE_DB_URL" -f migrations/${{ github.event.inputs.migration_file }}
          else
            echo "No DB URL, using REST API approach..."
            pip install httpx
            python3 << 'EOF'
          import httpx
          import json
          import os
          
          url = os.environ["SUPABASE_URL"]
          key = os.environ["SUPABASE_KEY"]
          
          headers = {
              "apikey": key,
              "Authorization": f"Bearer {key}",
              "Content-Type": "application/json"
          }
          
          # Try to access focus_scores table
          r = httpx.get(f"{url}/rest/v1/focus_scores?limit=1", headers=headers)
          print(f"Status: {r.status_code}")
          print(f"Response: {r.text[:200]}")
          
          if r.status_code == 200:
              print("✅ Table exists!")
          elif "Could not find" in r.text:
              print("❌ Table does not exist yet")
              print("Migration requires direct database access")
              print("Please set SUPABASE_DB_URL secret with format:")
              print("postgresql://postgres:[PASSWORD]@db.mocerqjnksmhcjzxrewo.supabase.co:5432/postgres")
          EOF
          fi
