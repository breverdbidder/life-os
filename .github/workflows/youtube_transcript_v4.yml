name: ðŸ“º YouTube Transcript V4 (Apify First)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube URL'
        required: true
        default: 'https://youtube.com/shorts/C2Dl6P7diHw'

env:
  SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co

jobs:
  transcribe:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¦ Install
        run: pip install requests httpx
          
      - name: ðŸ“º Apify Transcription
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          APIFY_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          python3 << 'PYEOF'
          import os, re, json, time, requests
          from datetime import datetime, timezone
          
          video_url = os.environ['VIDEO_URL']
          apify_token = os.environ['APIFY_TOKEN']
          supabase_key = os.environ.get('SUPABASE_KEY', '')
          supabase_url = os.environ.get('SUPABASE_URL', '')
          
          # Extract video ID
          patterns = [r'shorts/([a-zA-Z0-9_-]{11})', r'v=([a-zA-Z0-9_-]{11})', r'youtu\.be/([a-zA-Z0-9_-]{11})']
          video_id = None
          for p in patterns:
              m = re.search(p, video_url)
              if m:
                  video_id = m.group(1)
                  break
          
          if not video_id:
              print("âŒ Invalid URL")
              exit(1)
          
          print(f"ðŸ“º Video ID: {video_id}")
          print(f"ðŸš€ Starting Apify YouTube Transcript Scraper...")
          
          # Start Apify actor
          run_url = f"https://api.apify.com/v2/acts/pintostudio~youtube-transcript-scraper/runs?token={apify_token}"
          payload = {"startUrls": [f"https://www.youtube.com/watch?v={video_id}"], "maxResults": 1}
          
          resp = requests.post(run_url, json=payload, timeout=30)
          if resp.status_code != 201:
              print(f"âŒ Apify start failed: {resp.status_code}")
              exit(1)
          
          run_data = resp.json()['data']
          run_id = run_data['id']
          dataset_id = run_data['defaultDatasetId']
          print(f"   Run ID: {run_id}")
          
          # Wait for completion
          for i in range(24):  # 2 min max
              time.sleep(5)
              status_resp = requests.get(f"https://api.apify.com/v2/actor-runs/{run_id}?token={apify_token}")
              status = status_resp.json()['data']['status']
              print(f"   [{i*5}s] Status: {status}")
              
              if status == 'SUCCEEDED':
                  break
              elif status in ['FAILED', 'ABORTED', 'TIMED-OUT']:
                  print(f"âŒ Apify {status}")
                  exit(1)
          
          # Get results
          dataset_resp = requests.get(f"https://api.apify.com/v2/datasets/{dataset_id}/items?token={apify_token}")
          results = dataset_resp.json()
          
          if not results:
              print("âŒ No results")
              exit(1)
          
          item = results[0]
          transcript = item.get('transcript', '')
          title = item.get('videoTitle', 'Unknown')
          channel = item.get('channelName', 'Unknown')
          
          print(f"\n{'='*60}")
          print(f"ðŸ“ Title: {title}")
          print(f"ðŸ“º Channel: {channel}")
          print(f"{'='*60}")
          print(f"TRANSCRIPT:\n{transcript}")
          print(f"{'='*60}")
          print(f"âœ… {len(transcript)} chars | {len(transcript.split())} words")
          
          # Save
          output = {
              "video_id": video_id,
              "video_url": video_url,
              "title": title,
              "channel": channel,
              "transcript": transcript,
              "transcript_source": "apify",
              "extracted_at": datetime.now(timezone.utc).isoformat()
          }
          
          with open('transcript.json', 'w') as f:
              json.dump(output, f, indent=2)
          
          # Log to Supabase
          if supabase_key:
              headers = {"apikey": supabase_key, "Authorization": f"Bearer {supabase_key}", "Content-Type": "application/json"}
              insight = {
                  "user_id": 1,
                  "insight_type": "youtube_transcript",
                  "title": f"ðŸ“º {title[:80]}",
                  "content": transcript[:10000],
                  "category": "research",
                  "source": "apify",
                  "priority": 2,
                  "status": "Active"
              }
              requests.post(f"{supabase_url}/rest/v1/insights", headers=headers, json=insight, timeout=10)
              print("âœ… Saved to Supabase")
          
          PYEOF
          
      - name: ðŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: transcript-apify
          path: transcript.json
          retention-days: 30
