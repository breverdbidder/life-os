name: Sync Secrets to Cloudflare

on:
  workflow_dispatch:

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Set Cloudflare Environment Variables
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: 83ab3f2fbbabd1a9b01a018fb4efe219
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Update Life OS project with environment variables
          curl -s -X PATCH "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/life-os" \
            -H "Authorization: Bearer ${CF_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"deployment_configs\": {
                \"production\": {
                  \"env_vars\": {
                    \"ANTHROPIC_API_KEY\": {\"type\": \"secret_text\", \"value\": \"${ANTHROPIC_API_KEY}\"},
                    \"SUPABASE_URL\": {\"type\": \"plain_text\", \"value\": \"${SUPABASE_URL}\"},
                    \"SUPABASE_SERVICE_KEY\": {\"type\": \"secret_text\", \"value\": \"${SUPABASE_SERVICE_KEY}\"},
                    \"LIFE_OS_PASSWORD\": {\"type\": \"secret_text\", \"value\": \"LifeOS2025!\"}
                  }
                },
                \"preview\": {
                  \"env_vars\": {
                    \"ANTHROPIC_API_KEY\": {\"type\": \"secret_text\", \"value\": \"${ANTHROPIC_API_KEY}\"},
                    \"SUPABASE_URL\": {\"type\": \"plain_text\", \"value\": \"${SUPABASE_URL}\"},
                    \"SUPABASE_SERVICE_KEY\": {\"type\": \"secret_text\", \"value\": \"${SUPABASE_SERVICE_KEY}\"},
                    \"LIFE_OS_PASSWORD\": {\"type\": \"secret_text\", \"value\": \"LifeOS2025!\"}
                  }
                }
              }
            }"
          
          echo "âœ… Cloudflare environment variables synced"
