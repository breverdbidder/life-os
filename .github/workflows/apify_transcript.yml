name: ðŸŽ¬ Apify YouTube Transcript V2

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube URL'
        required: true

jobs:
  transcribe:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“º Get Transcript via Apify
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          APIFY_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
        run: |
          python3 << 'PYEOF'
          import os, re, requests, json, time
          from datetime import datetime, timezone
          
          url = os.environ.get('VIDEO_URL', '')
          apify_token = os.environ.get('APIFY_TOKEN', '')
          
          # Extract video ID
          patterns = [r'shorts/([a-zA-Z0-9_-]{11})', r'(?:v=|/v/)([a-zA-Z0-9_-]{11})', r'youtu\.be/([a-zA-Z0-9_-]{11})']
          video_id = None
          for p in patterns:
              m = re.search(p, url)
              if m:
                  video_id = m.group(1)
                  break
          
          print(f"ðŸ“º Video ID: {video_id}")
          print(f"ðŸ”‘ Token: {'SET' if apify_token else 'MISSING'}")
          
          # Use karamelo/youtube-transcripts - most reliable
          run_url = f"https://api.apify.com/v2/acts/karamelo~youtube-transcripts/runs?token={apify_token}"
          
          payload = {
              "startUrls": [f"https://www.youtube.com/watch?v={video_id}"],
              "outputFormat": "captions array with text only",
              "maxRetries": 3
          }
          
          print("ðŸš€ Starting Apify actor (karamelo/youtube-transcripts)...")
          resp = requests.post(run_url, json=payload, timeout=30)
          print(f"Response: {resp.status_code}")
          
          if resp.status_code == 201:
              run_data = resp.json()
              run_id = run_data['data']['id']
              dataset_id = run_data['data']['defaultDatasetId']
              print(f"Run ID: {run_id}")
              print(f"Dataset: {dataset_id}")
              
              # Wait for completion
              for i in range(24):  # 2 minutes max
                  time.sleep(5)
                  status_url = f"https://api.apify.com/v2/actor-runs/{run_id}?token={apify_token}"
                  status_resp = requests.get(status_url, timeout=10)
                  status = status_resp.json()['data']['status']
                  print(f"Status [{i+1}]: {status}")
                  
                  if status == 'SUCCEEDED':
                      dataset_url = f"https://api.apify.com/v2/datasets/{dataset_id}/items?token={apify_token}"
                      results = requests.get(dataset_url, timeout=30).json()
                      
                      print(f"Results: {json.dumps(results, indent=2)[:2000]}")
                      
                      if results:
                          item = results[0]
                          # Try different field names
                          transcript = (item.get('captions', '') or 
                                       item.get('transcript', '') or 
                                       item.get('text', '') or
                                       item.get('captionsText', '') or
                                       str(item.get('captionsArray', '')))
                          
                          # If captions is a list, join it
                          if isinstance(transcript, list):
                              transcript = ' '.join([c.get('text', str(c)) for c in transcript])
                          
                          title = item.get('title', item.get('videoTitle', 'Unknown'))
                          channel = item.get('channelName', item.get('channel', 'Unknown'))
                          
                          print(f"\n{'='*70}")
                          print(f"ðŸ“ TRANSCRIPT ({len(str(transcript))} chars):")
                          print(f"{'='*70}")
                          print(transcript)
                          
                          output = {
                              "video_id": video_id,
                              "video_url": url,
                              "title": title,
                              "channel": channel,
                              "transcript": transcript,
                              "transcript_length": len(str(transcript)),
                              "word_count": len(str(transcript).split()),
                              "transcript_source": "apify_karamelo",
                              "raw_result": item,
                              "extracted_at": datetime.now(timezone.utc).isoformat()
                          }
                          
                          with open('transcript.json', 'w') as f:
                              json.dump(output, f, indent=2)
                          
                          print(f"\nâœ… Success!")
                      break
                  elif status in ['FAILED', 'ABORTED', 'TIMED-OUT']:
                      print(f"âŒ Run failed: {status}")
                      break
          else:
              print(f"âŒ API Error: {resp.text}")
          PYEOF
          
      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apify-transcript-v2
          path: transcript.json
          retention-days: 30
          if-no-files-found: ignore
