name: RealTDM Title Search V2

on:
  workflow_dispatch:
    inputs:
      auction_date:
        description: 'Auction date MM/DD/YYYY'
        required: false
        default: '12/18/2025'

  repository_dispatch:
    types: [realtdm_title_search]

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Scrape RealTDM Case Details
        env:
          AUCTION_DATE: ${{ github.event.inputs.auction_date || '12/18/2025' }}
        run: |
          mkdir -p output
          
          cat << 'SCRIPT' > scrape.js
          const { chromium } = require('playwright');
          const fs = require('fs');
          
          const AUCTION_DATE = process.env.AUCTION_DATE || '12/18/2025';
          
          async function main() {
            console.log('üîç RealTDM Title Search Scraper V2');
            console.log(`üìÖ Auction Date: ${AUCTION_DATE}`);
            console.log('='.repeat(60));
            
            const browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox']
            });
            
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0',
              viewport: { width: 1920, height: 1080 },
              acceptDownloads: true
            });
            
            const page = await context.newPage();
            const results = [];
            
            try {
              // Step 1: Load the case list with date filter
              console.log('\n[1] Loading case list...');
              await page.goto('https://brevard.realtdm.com/public/cases/list', {
                waitUntil: 'networkidle',
                timeout: 60000
              });
              
              await page.waitForTimeout(3000);
              await page.screenshot({ path: 'output/01_initial_page.png', fullPage: true });
              
              // Step 2: Submit search with sale date filter
              console.log('[2] Submitting search filter...');
              
              // Fill date range
              await page.fill('#filterSaleDateStart', AUCTION_DATE);
              await page.fill('#filterSaleDateStop', AUCTION_DATE);
              
              // Click search
              await page.click('.filters-submit');
              await page.waitForTimeout(5000);
              await page.screenshot({ path: 'output/02_filtered_results.png', fullPage: true });
              
              // Step 3: Get all case rows
              const caseRows = await page.$$('tr.load-case[data-caseid]');
              console.log(`[3] Found ${caseRows.length} cases`);
              
              // Step 4: Click each case to see details
              for (let i = 0; i < caseRows.length; i++) {
                const row = caseRows[i];
                const caseId = await row.getAttribute('data-caseid');
                
                console.log(`\n[${i+1}/${caseRows.length}] Processing case ${caseId}...`);
                
                const caseResult = {
                  case_id: caseId,
                  title_search_found: false,
                  pdf_links: [],
                  case_info: {},
                  error: null
                };
                
                try {
                  // Extract case number and parcel from the row
                  const cells = await row.$$('td');
                  if (cells.length >= 7) {
                    caseResult.case_info.status = await cells[1].textContent();
                    caseResult.case_info.case_number = await cells[2].textContent();
                    caseResult.case_info.date_created = await cells[3].textContent();
                    caseResult.case_info.app_number = await cells[4].textContent();
                    caseResult.case_info.parcel = await cells[5].textContent();
                    caseResult.case_info.sale_date = await cells[6].textContent();
                    caseResult.case_info.surplus = await cells[7].textContent();
                    
                    // Clean up
                    Object.keys(caseResult.case_info).forEach(k => {
                      caseResult.case_info[k] = caseResult.case_info[k].trim();
                    });
                  }
                  
                  // Click on the row to open case detail modal
                  await row.click();
                  await page.waitForTimeout(3000);
                  
                  // Check for modal or new content
                  const modalContent = await page.$('.modal-body, .case-detail, #caseDetail');
                  
                  if (modalContent) {
                    console.log('  Found case detail modal');
                    await page.screenshot({ path: `output/case_${caseId}_modal.png` });
                    
                    // Look for PDF links
                    const pdfLinks = await page.$$eval('a[href*=".pdf"], a[href*="document"], a[href*="download"]', 
                      links => links.map(l => ({ href: l.href, text: l.textContent.trim() }))
                    );
                    
                    caseResult.pdf_links = pdfLinks;
                    
                    if (pdfLinks.length > 0) {
                      console.log(`  Found ${pdfLinks.length} document links`);
                      caseResult.title_search_found = pdfLinks.some(l => 
                        l.text.toLowerCase().includes('title') || 
                        l.text.toLowerCase().includes('search') ||
                        l.text.toLowerCase().includes('abstract')
                      );
                    }
                    
                    // Close modal
                    const closeBtn = await page.$('.close, [data-dismiss="modal"], .btn-close');
                    if (closeBtn) await closeBtn.click();
                    await page.waitForTimeout(1000);
                  } else {
                    // Page might have navigated - check current URL
                    const currentUrl = page.url();
                    console.log(`  Current URL: ${currentUrl}`);
                    await page.screenshot({ path: `output/case_${caseId}_page.png`, fullPage: true });
                    
                    // Save page HTML
                    const html = await page.content();
                    fs.writeFileSync(`output/case_${caseId}.html`, html);
                    
                    // Look for any PDF links on the page
                    const pdfLinks = await page.$$eval('a', links => 
                      links.filter(l => l.href && (l.href.includes('.pdf') || l.textContent.toLowerCase().includes('title')))
                            .map(l => ({ href: l.href, text: l.textContent.trim() }))
                    );
                    
                    caseResult.pdf_links = pdfLinks;
                    
                    // Go back to list
                    if (!currentUrl.includes('/list')) {
                      await page.goBack();
                      await page.waitForTimeout(2000);
                    }
                  }
                  
                } catch (error) {
                  console.log(`  ‚ùå Error: ${error.message}`);
                  caseResult.error = error.message;
                }
                
                results.push(caseResult);
              }
              
            } catch (error) {
              console.error('Fatal error:', error.message);
            }
            
            await browser.close();
            
            // Summary
            console.log('\n' + '='.repeat(60));
            console.log('üìä Summary');
            console.log('='.repeat(60));
            console.log(`Total cases: ${results.length}`);
            console.log(`With title search: ${results.filter(r => r.title_search_found).length}`);
            console.log(`With any PDFs: ${results.filter(r => r.pdf_links.length > 0).length}`);
            
            // Save results
            fs.writeFileSync('output/results.json', JSON.stringify(results, null, 2));
            
            // Also create a summary table
            let summary = '# RealTDM Title Search Results\\n\\n';
            summary += `**Auction Date:** ${AUCTION_DATE}\\n\\n`;
            summary += '| Case | Parcel | Status | Title Search | PDF Links |\\n';
            summary += '|------|--------|--------|--------------|-----------|\\n';
            
            for (const r of results) {
              const info = r.case_info;
              summary += `| ${info.case_number || r.case_id} | ${info.parcel || 'N/A'} | ${info.status || 'N/A'} | ${r.title_search_found ? '‚úÖ' : '‚ùå'} | ${r.pdf_links.length} |\\n`;
            }
            
            fs.writeFileSync('output/summary.md', summary);
            console.log('\\n‚úÖ Results saved to output/');
          }
          
          main().catch(console.error);
          SCRIPT
          
          node scrape.js

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: realtdm-title-search-${{ github.run_id }}
          path: output/
          retention-days: 90
