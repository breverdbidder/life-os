name: Setup Life OS Chat Infrastructure

on:
  workflow_dispatch:

jobs:
  setup-supabase:
    runs-on: ubuntu-latest
    steps:
      - name: Create chat_sessions table
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Use Supabase REST API to check if table exists and create via raw SQL
          # First, try to query the table - if it fails, we need to create it
          
          echo "Checking if chat_sessions table exists..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${SUPABASE_URL}/rest/v1/chat_sessions?limit=1" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ chat_sessions table already exists"
          else
            echo "Table doesn't exist, creating via postgres connection..."
            
            # Install psql
            sudo apt-get update && sudo apt-get install -y postgresql-client
            
            # Extract project ref from URL
            PROJECT_REF=$(echo $SUPABASE_URL | sed 's|https://||' | sed 's|.supabase.co||')
            
            # Create table via direct SQL
            PGPASSWORD="${SUPABASE_SERVICE_KEY}" psql \
              "postgresql://postgres.${PROJECT_REF}:${SUPABASE_SERVICE_KEY}@aws-0-us-east-1.pooler.supabase.com:6543/postgres" \
              -c "
              CREATE TABLE IF NOT EXISTS chat_sessions (
                  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                  session_id TEXT NOT NULL UNIQUE,
                  messages JSONB,
                  last_response TEXT,
                  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
              );
              CREATE INDEX IF NOT EXISTS idx_chat_sessions_session_id ON chat_sessions(session_id);
              " || echo "Note: May need to create table via Supabase dashboard"
            
            echo "✅ Migration attempted"
          fi

  setup-vercel:
    runs-on: ubuntu-latest
    steps:
      - name: Set Vercel Environment Variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          PROJECT_ID="prj_U0VyR305H2KnOMptJ4brMkFPbfjS"
          
          echo "Setting ANTHROPIC_API_KEY..."
          curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"key\": \"ANTHROPIC_API_KEY\",
              \"value\": \"${ANTHROPIC_API_KEY}\",
              \"type\": \"encrypted\",
              \"target\": [\"production\", \"preview\", \"development\"]
            }"
          
          echo "Setting SUPABASE_URL..."
          curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"key\": \"SUPABASE_URL\",
              \"value\": \"${SUPABASE_URL}\",
              \"type\": \"encrypted\",
              \"target\": [\"production\", \"preview\", \"development\"]
            }"
          
          echo "Setting SUPABASE_SERVICE_KEY..."
          curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"key\": \"SUPABASE_SERVICE_KEY\",
              \"value\": \"${SUPABASE_SERVICE_KEY}\",
              \"type\": \"encrypted\",
              \"target\": [\"production\", \"preview\", \"development\"]
            }"
          
          echo "Setting LIFE_OS_PASSWORD..."
          curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"key\": \"LIFE_OS_PASSWORD\",
              \"value\": \"LifeOS2025!\",
              \"type\": \"encrypted\",
              \"target\": [\"production\", \"preview\", \"development\"]
            }"
          
          echo "✅ Vercel environment variables set"

  redeploy:
    needs: [setup-supabase, setup-vercel]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Vercel Redeploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Triggering redeploy to apply new env vars..."
          curl -s -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "life-os",
              "project": "prj_U0VyR305H2KnOMptJ4brMkFPbfjS",
              "target": "production",
              "gitSource": {
                "type": "github",
                "repoId": "breverdbidder/life-os",
                "ref": "main"
              }
            }' || echo "Redeploy may need manual trigger"
          
          echo "✅ Setup complete!"
          echo ""
          echo "Test at: https://shapira-life-os.vercel.app/chat.html"
          echo "Password: LifeOS2025!"
