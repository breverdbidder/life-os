name: RealForeclose Tax Deed Scraper

on:
  workflow_dispatch:
    inputs:
      auction_date:
        description: 'Auction date (MM/DD/YYYY)'
        required: true
        default: '12/18/2025'
  schedule:
    - cron: '0 13 18 12 *'

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Scrape Tax Deed Auctions
        env:
          RF_USERNAME: ${{ secrets.RF_USERNAME }}
          RF_PASSWORD: ${{ secrets.RF_PASSWORD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          cat << 'SCRIPT' > scrape.js
          const { chromium } = require('playwright');
          const fs = require('fs');
          
          const AUCTION_DATE = '${{ github.event.inputs.auction_date }}' || '12/18/2025';
          const USERNAME = process.env.RF_USERNAME || '';
          const PASSWORD = process.env.RF_PASSWORD || '';
          
          async function dismissPopups(page, maxAttempts = 5) {
            for (let i = 0; i < maxAttempts; i++) {
              try {
                const okButton = await page.$('input[value="OK"], input[value="ok"]');
                if (okButton) {
                  await okButton.click();
                  await page.waitForTimeout(800);
                } else break;
              } catch (e) { break; }
            }
          }
          
          async function scrape() {
            console.log('='.repeat(60));
            console.log('üèõÔ∏è BidDeed.AI - Tax Deed Scraper V4');
            console.log('='.repeat(60));
            console.log('üìÖ Target:', AUCTION_DATE);
            
            const browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0',
              viewport: { width: 1920, height: 1080 }
            });
            
            const page = await context.newPage();
            const results = { 
              properties: [], 
              metadata: {
                auction_date: AUCTION_DATE,
                auction_type: 'Tax Deed',
                source: 'brevard.realforeclose.com'
              }
            };
            
            try {
              // Step 1: Load and login
              console.log('\n[1] Loading site...');
              await page.goto('https://brevard.realforeclose.com/index.cfm', {
                waitUntil: 'networkidle', timeout: 60000
              });
              await page.waitForTimeout(2000);
              
              if (USERNAME && PASSWORD) {
                console.log('[2] Logging in...');
                await page.fill('#LogName', USERNAME);
                await page.fill('#LogPass', PASSWORD);
                await page.click('#LogButton');
                await page.waitForTimeout(3000);
                await dismissPopups(page);
                results.metadata.logged_in = true;
                console.log('  ‚úÖ Logged in');
              }
              
              // Step 2: Go directly to Place Bid / DAYLIST page (has actual listings)
              console.log('\n[3] Loading auction listings...');
              await page.goto('https://brevard.realforeclose.com/index.cfm?zaction=AUCTION&zmethod=DAYLIST', {
                waitUntil: 'networkidle', timeout: 60000
              });
              await page.waitForTimeout(2000);
              await dismissPopups(page);
              await page.screenshot({ path: 'auction_list.png', fullPage: true });
              
              // Step 3: Extract data from all pages
              console.log('\n[4] Extracting auction data...');
              let allHtml = await page.content();
              fs.writeFileSync('auction_page1.html', allHtml);
              
              // Check for pagination
              const pageMatch = allHtml.match(/page \d+ of (\d+)/);
              const totalPages = pageMatch ? parseInt(pageMatch[1]) : 1;
              console.log(`  Pages: ${totalPages}`);
              
              // Go through all pages
              for (let p = 2; p <= totalPages && p <= 10; p++) {
                try {
                  const nextBtn = await page.$('input[value="NEXT >"]');
                  if (nextBtn) {
                    await nextBtn.click();
                    await page.waitForTimeout(2000);
                    await dismissPopups(page);
                    const pageHtml = await page.content();
                    allHtml += pageHtml;
                    fs.writeFileSync(`auction_page${p}.html`, pageHtml);
                    console.log(`  Loaded page ${p}`);
                  }
                } catch (e) { break; }
              }
              
              // Step 4: Parse the data
              console.log('\n[5] Parsing listings...');
              
              // Extract case numbers (6-digit)
              const caseNums = [...new Set(allHtml.match(/>(\d{6})</g) || [])].map(m => m.slice(1, -1));
              
              // Extract opening bids
              const bids = (allHtml.match(/Opening Bid:[^$]*\$([0-9,]+\.\d+)/g) || [])
                .map(m => parseFloat(m.replace(/[^0-9.]/g, '')));
              
              // Extract assessed values
              const assessed = (allHtml.match(/Assessed Value:[^$]*\$([0-9,]+\.\d+)/g) || [])
                .map(m => parseFloat(m.replace(/[^0-9.]/g, '')));
              
              // Extract parcel IDs (7-digit)
              const parcels = [...new Set(allHtml.match(/>(\d{7})</g) || [])].map(m => m.slice(1, -1));
              
              // Build property list
              for (let i = 0; i < caseNums.length; i++) {
                results.properties.push({
                  case_number: caseNums[i] || null,
                  opening_bid: bids[i] || null,
                  assessed_value: assessed[i] || null,
                  parcel_id: parcels[i] || null,
                  auction_date: AUCTION_DATE,
                  auction_type: 'Tax Deed'
                });
              }
              
              // Summary stats
              results.metadata.total_properties = results.properties.length;
              results.metadata.total_opening_bids = results.properties.reduce((sum, p) => sum + (p.opening_bid || 0), 0);
              results.metadata.total_assessed_value = results.properties.reduce((sum, p) => sum + (p.assessed_value || 0), 0);
              results.metadata.scraped_at = new Date().toISOString();
              results.metadata.status = results.properties.length > 0 ? 'data_found' : 'no_data';
              
              console.log(`\n  ‚úÖ Found ${results.properties.length} properties`);
              console.log(`  üí∞ Total Opening Bids: $${results.metadata.total_opening_bids.toLocaleString()}`);
              console.log(`  üè† Total Assessed: $${results.metadata.total_assessed_value.toLocaleString()}`);
              
            } catch (error) {
              console.error('‚ùå Error:', error.message);
              results.error = error.message;
            } finally {
              await browser.close();
            }
            
            fs.writeFileSync('taxdeed_results.json', JSON.stringify(results, null, 2));
            
            console.log('\n' + '='.repeat(60));
            console.log('üìä COMPLETE');
            console.log('='.repeat(60));
          }
          
          scrape().catch(console.error);
          SCRIPT
          
          node scrape.js

      - name: Save to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          if [ -f "taxdeed_results.json" ]; then
            curl -s -X POST "$SUPABASE_URL/rest/v1/insights" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"category\": \"taxdeed_auction\",
                \"content\": \"Dec 18 Tax Deed - $(cat taxdeed_results.json | jq -r '.metadata.total_properties') properties\",
                \"metadata\": $(cat taxdeed_results.json)
              }" && echo "‚úÖ Saved to Supabase"
          fi

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: taxdeed-${{ github.run_id }}
          path: |
            *.png
            *.html
            *.json
          retention-days: 30
