name: RealForeclose Tax Deed Scraper V2

on:
  workflow_dispatch:
    inputs:
      auction_date:
        description: 'Auction date (MM/DD/YYYY)'
        required: true
        default: '12/18/2025'
  schedule:
    - cron: '0 13 18 12 *'  # 8 AM EST on Dec 18

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Scrape RealForeclose
        env:
          RF_USERNAME: ${{ secrets.RF_USERNAME }}
          RF_PASSWORD: ${{ secrets.RF_PASSWORD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          cat << 'SCRIPT' > scrape.js
          const { chromium } = require('playwright');
          const fs = require('fs');
          
          const AUCTION_DATE = '${{ github.event.inputs.auction_date }}' || '12/18/2025';
          const USERNAME = process.env.RF_USERNAME || '';
          const PASSWORD = process.env.RF_PASSWORD || '';
          
          async function scrape() {
            console.log('='.repeat(60));
            console.log('üèõÔ∏è BidDeed.AI - RealForeclose Tax Deed Scraper V2');
            console.log('='.repeat(60));
            console.log('üìÖ Date:', AUCTION_DATE);
            console.log('üë§ User:', USERNAME ? USERNAME.substring(0,3) + '***' : 'Anonymous');
            
            const browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0 Safari/537.36',
              viewport: { width: 1920, height: 1080 }
            });
            
            const page = await context.newPage();
            const results = { 
              properties: [], 
              metadata: {
                auction_date: AUCTION_DATE,
                auction_type: 'Tax Deed',
                source: 'brevard.realforeclose.com'
              }
            };
            
            try {
              // Step 1: Load main page
              console.log('\n[1] Loading RealForeclose...');
              await page.goto('https://brevard.realforeclose.com/index.cfm', {
                waitUntil: 'networkidle',
                timeout: 60000
              });
              await page.waitForTimeout(2000);
              await page.screenshot({ path: 'step1_main.png', fullPage: true });
              
              // Step 2: Login
              if (USERNAME && PASSWORD) {
                console.log('\n[2] Logging in...');
                try {
                  await page.waitForSelector('#LogName', { timeout: 5000 });
                  await page.fill('#LogName', USERNAME);
                  await page.fill('#LogPass', PASSWORD);
                  await page.click('#LogButton');
                  await page.waitForTimeout(3000);
                  
                  // Check for popup modal and dismiss it
                  try {
                    const okButton = await page.$('input[value="OK"], button:has-text("OK")');
                    if (okButton) {
                      console.log('  Dismissing popup...');
                      await okButton.click();
                      await page.waitForTimeout(1000);
                    }
                  } catch (e) {}
                  
                  await page.screenshot({ path: 'step2_login.png', fullPage: true });
                  
                  const html = await page.content();
                  results.metadata.logged_in = html.includes('Welcome:') || html.includes('Everest8');
                  console.log('  Login:', results.metadata.logged_in ? '‚úÖ Success' : '‚ùå Failed');
                } catch (e) {
                  console.log('  Login error:', e.message);
                }
              }
              
              // Step 3: Navigate to Calendar
              console.log('\n[3] Going to Calendar...');
              await page.goto('https://brevard.realforeclose.com/index.cfm?zaction=AUCTION&zmethod=CALENDAR', {
                waitUntil: 'networkidle',
                timeout: 60000
              });
              await page.waitForTimeout(2000);
              
              // Dismiss any popups
              try {
                const okBtn = await page.$('input[value="OK"]');
                if (okBtn) await okBtn.click();
              } catch (e) {}
              
              await page.screenshot({ path: 'step3_calendar.png', fullPage: true });
              
              // Step 4: Navigate to specific auction date
              console.log('\n[4] Going to', AUCTION_DATE, '...');
              await page.goto(`https://brevard.realforeclose.com/index.cfm?zaction=AUCTION&zmethod=PREVIEW&AuctionDate=${AUCTION_DATE}`, {
                waitUntil: 'networkidle',
                timeout: 60000
              });
              await page.waitForTimeout(2000);
              
              // Dismiss popups again
              try {
                const okBtn = await page.$('input[value="OK"]');
                if (okBtn) await okBtn.click();
                await page.waitForTimeout(500);
              } catch (e) {}
              
              await page.screenshot({ path: 'step4_auction.png', fullPage: true });
              
              // Step 5: Extract data
              console.log('\n[5] Extracting data...');
              const html = await page.content();
              fs.writeFileSync('auction_page.html', html);
              
              // Check for listings
              if (html.toLowerCase().includes('no cases currently') || 
                  html.toLowerCase().includes('there are no cases')) {
                console.log('  ‚ö†Ô∏è No cases posted yet');
                results.metadata.status = 'no_cases_posted';
              } else {
                // Try to find auction items in the page
                const items = await page.$$eval('.AUCTION_ITEM, .auction-item, tr.item, [class*="auction"]', els => {
                  return els.map(el => ({
                    text: el.innerText,
                    html: el.innerHTML.substring(0, 500)
                  }));
                });
                console.log('  Found', items.length, 'potential items');
                
                // Also try AESSION extraction
                const aessions = html.match(/AESSION=([A-Za-z0-9]+)/gi) || [];
                const uniqueAessions = [...new Set(aessions.map(a => a.split('=')[1]))];
                console.log('  AESSION IDs:', uniqueAessions.length);
                
                // Case numbers
                const cases = html.match(/\d{4}TD\d+/g) || [];
                const uniqueCases = [...new Set(cases)];
                console.log('  Case numbers:', uniqueCases.length);
                
                for (let i = 0; i < Math.max(uniqueAessions.length, uniqueCases.length, items.length); i++) {
                  results.properties.push({
                    aession: uniqueAessions[i] || null,
                    case_number: uniqueCases[i] || null,
                    raw_text: items[i]?.text?.substring(0, 200) || null
                  });
                }
                
                results.metadata.status = results.properties.length > 0 ? 'data_found' : 'no_data';
              }
              
              // Step 6: Try Place Bid page for more data
              console.log('\n[6] Checking Place Bid page...');
              await page.goto('https://brevard.realforeclose.com/index.cfm?zaction=AUCTION&zmethod=DAYLIST', {
                waitUntil: 'networkidle',
                timeout: 30000
              });
              await page.waitForTimeout(1000);
              
              try {
                const okBtn = await page.$('input[value="OK"]');
                if (okBtn) await okBtn.click();
              } catch (e) {}
              
              await page.screenshot({ path: 'step6_placebid.png', fullPage: true });
              
              const bidHtml = await page.content();
              fs.writeFileSync('placebid_page.html', bidHtml);
              
              // Check for auction items on Place Bid page
              const bidAessions = bidHtml.match(/AESSION=([A-Za-z0-9]+)/gi) || [];
              if (bidAessions.length > 0) {
                console.log('  Found', bidAessions.length, 'items on Place Bid page');
              }
              
              results.metadata.scraped_at = new Date().toISOString();
              results.metadata.total_properties = results.properties.length;
              
            } catch (error) {
              console.error('\n‚ùå Error:', error.message);
              results.error = error.message;
            } finally {
              await browser.close();
            }
            
            fs.writeFileSync('taxdeed_results.json', JSON.stringify(results, null, 2));
            
            console.log('\n' + '='.repeat(60));
            console.log('üìä SUMMARY');
            console.log('  Date:', results.metadata.auction_date);
            console.log('  Logged In:', results.metadata.logged_in);
            console.log('  Status:', results.metadata.status);
            console.log('  Properties:', results.properties.length);
            console.log('='.repeat(60));
          }
          
          scrape().catch(console.error);
          SCRIPT
          
          node scrape.js

      - name: Save to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          if [ -f "taxdeed_results.json" ]; then
            curl -s -X POST "$SUPABASE_URL/rest/v1/insights" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"category\": \"taxdeed_auction\",
                \"content\": \"RealForeclose Tax Deed - ${{ github.event.inputs.auction_date }}\",
                \"metadata\": $(cat taxdeed_results.json)
              }" && echo "‚úÖ Saved"
          fi

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: taxdeed-v2-${{ github.run_id }}
          path: |
            *.png
            *.html
            *.json
          retention-days: 30
