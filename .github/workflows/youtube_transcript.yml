name: YouTube Transcript - Apify Premium

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true
        default: 'https://youtu.be/NuKrtiJqW3Y'

jobs:
  transcript:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Extract Transcript via Apify
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          VIDEO_URL: ${{ github.event.inputs.video_url }}
        run: |
          cat > transcript_apify.py << 'SCRIPT'
          #!/usr/bin/env python3
          import os
          import sys
          import json
          import time
          import requests
          
          APIFY_TOKEN = os.environ.get('APIFY_API_TOKEN')
          VIDEO_URL = os.environ.get('VIDEO_URL', 'https://youtu.be/NuKrtiJqW3Y')
          ACTOR_ID = "smartly_automated/youtube-transcript-scraper-premium-version"
          
          def run_apify_actor(video_url):
              if not APIFY_TOKEN:
                  print("âŒ APIFY_API_TOKEN not set")
                  return None
              
              run_url = f"https://api.apify.com/v2/acts/{ACTOR_ID}/runs"
              payload = {
                  "videoUrls": [video_url],
                  "includeComments": False,
                  "languageCodes": ["en"]
              }
              
              print(f"ðŸš€ Starting Apify actor: {ACTOR_ID}")
              print(f"ðŸ“¹ Video: {video_url}")
              
              response = requests.post(
                  run_url,
                  params={'token': APIFY_TOKEN},
                  json=payload,
                  headers={'Content-Type': 'application/json'}
              )
              
              if response.status_code != 201:
                  print(f"âŒ Failed to start actor: {response.status_code}")
                  print(response.text)
                  return None
              
              run_data = response.json()['data']
              run_id = run_data['id']
              default_dataset_id = run_data['defaultDatasetId']
              
              print(f"âœ… Actor started. Run ID: {run_id}")
              print(f"â³ Waiting for completion...")
              
              status_url = f"https://api.apify.com/v2/acts/{ACTOR_ID}/runs/{run_id}"
              max_wait = 180
              elapsed = 0
              
              while elapsed < max_wait:
                  time.sleep(5)
                  elapsed += 5
                  
                  status_response = requests.get(status_url, params={'token': APIFY_TOKEN})
                  status_data = status_response.json()['data']
                  status = status_data['status']
                  
                  if status == 'SUCCEEDED':
                      print(f"âœ… Actor completed successfully!")
                      break
                  elif status in ['FAILED', 'ABORTED']:
                      print(f"âŒ Actor run {status.lower()}")
                      return None
                  else:
                      print(f"â³ Status: {status} ({elapsed}s elapsed)")
              
              if elapsed >= max_wait:
                  print(f"âŒ Timeout waiting for actor")
                  return None
              
              dataset_url = f"https://api.apify.com/v2/datasets/{default_dataset_id}/items"
              dataset_response = requests.get(dataset_url, params={'token': APIFY_TOKEN})
              
              if dataset_response.status_code != 200:
                  print(f"âŒ Failed to fetch dataset: {dataset_response.status_code}")
                  return None
              
              results = dataset_response.json()
              return results[0] if results else None
          
          def main():
              result = run_apify_actor(VIDEO_URL)
              
              if not result:
                  sys.exit(1)
              
              transcript = result.get('transcript', '')
              title = result.get('title', 'Unknown')
              channel = result.get('channelTitle', 'Unknown')
              duration = result.get('duration', 'Unknown')
              
              if not transcript:
                  print("âŒ No transcript found")
                  print(f"Result keys: {list(result.keys())}")
                  sys.exit(1)
              
              output_file = 'transcript_output.txt'
              
              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write(f"YouTube Video Transcript\n")
                  f.write(f"{'=' * 80}\n\n")
                  f.write(f"Title: {title}\n")
                  f.write(f"Channel: {channel}\n")
                  f.write(f"Duration: {duration}\n")
                  f.write(f"URL: {VIDEO_URL}\n")
                  f.write(f"Method: Apify Premium (99.4% success)\n")
                  f.write(f"\n{'=' * 80}\n\n")
                  f.write(transcript)
              
              print(f"\nâœ… SUCCESS!")
              print(f"ðŸ“ Title: {title}")
              print(f"ðŸ“º Channel: {channel}")
              print(f"â±ï¸  Duration: {duration}")
              print(f"ðŸ“Š Length: {len(transcript)} chars")
              print(f"\nðŸ“„ Preview:\n")
              print(transcript[:2000])
              if len(transcript) > 2000:
                  print("...")
          
          if __name__ == '__main__':
              main()
          SCRIPT
          
          python transcript_apify.py
      
      - name: Upload Transcript
        uses: actions/upload-artifact@v4
        with:
          name: youtube-transcript
          path: transcript_output.txt
          retention-days: 30
