name: YouTube Transcript Extractor

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true
        default: 'https://www.youtube.com/watch?v=NuKrtiJqW3Y'
      actor_id:
        description: 'Apify Actor ID'
        required: false
        default: 'topaz_sharingan~youtube-transcript-scraper'

jobs:
  extract_transcript:
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract YouTube Transcript via Apify
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os, sys, json, time, requests
          from urllib.parse import urlparse, parse_qs
          
          def extract_video_id(url):
              parsed = urlparse(url)
              if parsed.hostname in ['www.youtube.com', 'youtube.com']:
                  if parsed.path == '/watch':
                      return parse_qs(parsed.query).get('v', [None])[0]
              elif parsed.hostname == 'youtu.be':
                  return parsed.path.lstrip('/')
              return None
          
          video_url = "${{ github.event.inputs.video_url }}"
          actor_id = "${{ github.event.inputs.actor_id }}" or "topaz_sharingan~youtube-transcript-scraper"
          apify_token = os.environ.get('APIFY_API_TOKEN')
          
          if not apify_token:
              print("::error::APIFY_API_TOKEN not found")
              sys.exit(1)
          
          video_id = extract_video_id(video_url)
          if not video_id:
              print(f"::error::Could not extract video ID from {video_url}")
              sys.exit(1)
          
          print(f"ðŸ“¹ Video ID: {video_id}")
          print(f"ðŸš€ Actor: {actor_id}\n")
          
          # Start actor with corrected input format
          run_url = f"https://api.apify.com/v2/acts/{actor_id}/runs"
          payload = {"startUrls": [{"url": video_url}]}  # Corrected input format
          headers = {
              "Authorization": f"Bearer {apify_token}",
              "Content-Type": "application/json"
          }
          
          response = requests.post(run_url, json=payload, headers=headers, timeout=30)
          response.raise_for_status()
          run_id = response.json()['data']['id']
          
          print(f"âœ… Run ID: {run_id}")
          print("â³ Waiting...\n")
          
          # Poll for completion
          for i in range(60):  # 5 minutes max
              time.sleep(5)
              status_url = f"https://api.apify.com/v2/acts/{actor_id}/runs/{run_id}"
              status_data = requests.get(status_url, headers=headers, timeout=10).json()
              status = status_data['data']['status']
              
              print(f"[{i*5}s] {status}")
              
              if status in ['SUCCEEDED', 'FAILED', 'ABORTED', 'TIMED-OUT']:
                  break
          
          if status != 'SUCCEEDED':
              print(f"::error::Run {status}")
              sys.exit(1)
          
          # Get results
          dataset_url = f"https://api.apify.com/v2/acts/{actor_id}/runs/{run_id}/dataset/items"
          results = requests.get(dataset_url, headers=headers, timeout=30).json()
          
          if not results:
              print("::error::No results")
              sys.exit(1)
          
          # Extract transcript
          data = results[0]
          transcript_text = data.get('transcript', data.get('text', ''))
          
          if not transcript_text:
              print(f"::warning::Available fields: {list(data.keys())}")
              # Try to find any text field
              for k, v in data.items():
                  if isinstance(v, str) and len(v) > 50:
                      transcript_text = v
                      break
          
          if not transcript_text:
              print("::error::No transcript found")
              print(json.dumps(data, indent=2)[:500])
              sys.exit(1)
          
          # Save
          output_file = f'transcript_{video_id}.txt'
          with open(output_file, 'w') as f:
              f.write(f"YouTube: https://www.youtube.com/watch?v={video_id}\n")
              f.write(f"Extracted: {time.strftime('%Y-%m-%d %H:%M:%S UTC')}\n")
              f.write(f"Method: Apify {actor_id}\n\n{'='*80}\n\n{transcript_text}")
          
          print(f"\nâœ… Saved: {output_file}")
          print(f"ðŸ“Š {len(transcript_text.split())} words | {len(transcript_text)} chars\n")
          print("="*80)
          print(transcript_text[:2000])
          if len(transcript_text) > 2000:
              print("\n...(truncated)")
          print("="*80)
          
          with open(f'transcript_{video_id}_meta.json', 'w') as f:
              json.dump(data, f, indent=2)
          PYTHON_SCRIPT
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-transcript
          path: transcript_*
          retention-days: 30
