name: YouTube Transcript Extractor

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true
        default: 'https://www.youtube.com/watch?v=NuKrtiJqW3Y'

jobs:
  extract_transcript:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Extract YouTube Transcript via Apify
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          import sys
          import json
          import time
          import requests
          from urllib.parse import urlparse, parse_qs
          
          def extract_video_id(url):
              """Extract YouTube video ID from URL"""
              parsed = urlparse(url)
              if parsed.hostname in ['www.youtube.com', 'youtube.com']:
                  if parsed.path == '/watch':
                      return parse_qs(parsed.query).get('v', [None])[0]
              elif parsed.hostname == 'youtu.be':
                  return parsed.path.lstrip('/')
              return None
          
          def run_apify_transcript(video_url):
              """Extract transcript using Apify"""
              apify_token = os.environ.get('APIFY_API_TOKEN')
              
              if not apify_token:
                  print("::error::APIFY_API_TOKEN not found in secrets")
                  sys.exit(1)
              
              # Best rated YouTube transcript actor
              actor_id = 'karamelo/youtube-structured-transcript-extractor'
              
              print(f"ðŸš€ Starting Apify Actor: {actor_id}")
              print(f"ðŸ“¹ Video URL: {video_url}\n")
              
              # Start actor run
              run_url = f"https://api.apify.com/v2/acts/{actor_id}/runs"
              
              payload = {
                  "videoUrls": [video_url],
                  "outputFormat": "captions_array_text_only"
              }
              
              headers = {
                  "Authorization": f"Bearer {apify_token}",
                  "Content-Type": "application/json"
              }
              
              # Start the run
              response = requests.post(run_url, json=payload, headers=headers, timeout=30)
              response.raise_for_status()
              run_data = response.json()
              run_id = run_data['data']['id']
              
              print(f"âœ… Actor started. Run ID: {run_id}")
              print("â³ Waiting for completion...\n")
              
              # Poll for completion (max 3 minutes)
              for i in range(36):  # 36 * 5 = 180 seconds
                  time.sleep(5)
                  status_url = f"https://api.apify.com/v2/acts/{actor_id}/runs/{run_id}"
                  status_response = requests.get(status_url, headers=headers, timeout=10)
                  status_data = status_response.json()
                  
                  status = status_data['data']['status']
                  print(f"[{i*5}s] Status: {status}")
                  
                  if status in ['SUCCEEDED', 'FAILED', 'ABORTED', 'TIMED-OUT']:
                      break
              
              if status != 'SUCCEEDED':
                  print(f"::error::Actor run {status}")
                  sys.exit(1)
              
              # Get results
              print("\nðŸ“¥ Fetching results...")
              dataset_url = f"https://api.apify.com/v2/acts/{actor_id}/runs/{run_id}/dataset/items"
              dataset_response = requests.get(dataset_url, headers=headers, timeout=30)
              dataset_response.raise_for_status()
              results = dataset_response.json()
              
              if not results or len(results) == 0:
                  print("::error::No results returned from Apify")
                  sys.exit(1)
              
              return results[0]
          
          def save_transcript(data, video_id):
              """Save transcript to workspace"""
              
              # Extract transcript text from various possible fields
              transcript_text = ""
              
              if 'transcript' in data:
                  transcript_text = data['transcript']
              elif 'captions' in data:
                  captions = data['captions']
                  if isinstance(captions, list):
                      transcript_text = ' '.join([c.get('text', '') for c in captions if 'text' in c])
                  elif isinstance(captions, str):
                      transcript_text = captions
              elif 'text' in data:
                  transcript_text = data['text']
              
              if not transcript_text:
                  print(f"::warning::Could not extract transcript. Available fields: {list(data.keys())}")
                  print("::warning::Full response:")
                  print(json.dumps(data, indent=2)[:1000])
                  
                  # Try to get any text-like field
                  for key, value in data.items():
                      if isinstance(value, str) and len(value) > 100:
                          transcript_text = value
                          break
              
              if not transcript_text:
                  print("::error::No transcript text found in response")
                  sys.exit(1)
              
              # Save to file
              output_file = f'transcript_{video_id}.txt'
              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write(f"YouTube Video: https://www.youtube.com/watch?v={video_id}\n")
                  f.write(f"Transcription Method: Apify API (karamelo/youtube-structured-transcript-extractor)\n")
                  f.write(f"Extraction Date: {time.strftime('%Y-%m-%d %H:%M:%S UTC')}\n")
                  f.write(f"\n{'=' * 80}\n\n")
                  f.write(transcript_text)
              
              print(f"\nâœ… Transcript saved to {output_file}")
              print(f"ðŸ“Š Word count: {len(transcript_text.split())} words")
              print(f"ðŸ“Š Character count: {len(transcript_text)} characters")
              print(f"\n{'=' * 80}")
              print("TRANSCRIPT PREVIEW (first 2000 chars):")
              print('=' * 80)
              print(transcript_text[:2000])
              if len(transcript_text) > 2000:
                  print("\n... (truncated, see full file)")
              print('=' * 80)
              
              # Also save metadata
              metadata_file = f'transcript_{video_id}_metadata.json'
              with open(metadata_file, 'w') as f:
                  json.dump(data, f, indent=2)
              print(f"\nðŸ“‹ Metadata saved to {metadata_file}")
              
              return output_file
          
          # Main execution
          video_url = "${{ github.event.inputs.video_url }}"
          video_id = extract_video_id(video_url)
          
          if not video_id:
              print(f"::error::Could not extract video ID from URL: {video_url}")
              sys.exit(1)
          
          print(f"ðŸ“¹ Video ID: {video_id}\n")
          
          # Run Apify extraction
          result = run_apify_transcript(video_url)
          
          # Save transcript
          output_file = save_transcript(result, video_id)
          
          print(f"\nðŸŽ‰ SUCCESS! Transcript extracted to {output_file}")
          PYTHON_SCRIPT
      
      - name: Upload transcript as artifact
        uses: actions/upload-artifact@v4
        with:
          name: youtube-transcript
          path: |
            transcript_*.txt
            transcript_*_metadata.json
          retention-days: 30
      
      - name: Commit transcript to repository (optional)
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add transcript_*.txt transcript_*_metadata.json || true
          git commit -m "Add YouTube transcript: ${{ github.event.inputs.video_url }}" || echo "No changes to commit"
          git push || echo "Nothing to push"
