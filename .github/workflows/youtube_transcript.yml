name: YouTube Transcript Agent

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true
        type: string

jobs:
  transcript:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install --break-system-packages youtube-transcript-api
      
      - name: Extract Transcript
        env:
          VIDEO_URL: ${{ inputs.video_url }}
        run: |
          python3 << 'PYTHON'
          import os
          import re
          from youtube_transcript_api import YouTubeTranscriptApi

          video_url = os.environ['VIDEO_URL']
          
          # Extract video ID
          patterns = [
              r'(?:v=|\/)([0-9A-Za-z_-]{11}).*',
              r'youtu\.be\/([0-9A-Za-z_-]{11})',
          ]
          
          video_id = None
          for pattern in patterns:
              match = re.search(pattern, video_url)
              if match:
                  video_id = match.group(1)
                  break
          
          if not video_id:
              print(f"âŒ Could not extract video ID from {video_url}")
              exit(1)
          
          print(f"ðŸ“¹ Video ID: {video_id}")
          print("ðŸ”„ Fetching transcript...")
          
          try:
              # Create API instance and fetch transcript
              api = YouTubeTranscriptApi()
              transcript_list = api.list(video_id)
              
              # Get first available transcript
              transcript_data = None
              for transcript in transcript_list:
                  transcript_data = transcript.fetch()
                  break
              
              if not transcript_data:
                  print("âŒ No transcript available")
                  exit(1)
              
              # Combine segments
              full_text = " ".join([seg['text'] for seg in transcript_data])
              full_text = full_text.replace('\n', ' ').replace('  ', ' ')
              
              # Write output
              with open('transcript_output.txt', 'w') as f:
                  f.write("YouTube Video Transcript\n")
                  f.write("=" * 80 + "\n\n")
                  f.write(f"Video ID: {video_id}\n")
                  f.write(f"URL: {video_url}\n")
                  f.write(f"Method: youtube-transcript-api (FREE)\n\n")
                  f.write("=" * 80 + "\n\n")
                  f.write(full_text)
              
              print("âœ… SUCCESS!")
              print(f"ðŸ“Š Length: {len(full_text)} characters")
              print(f"\nðŸ“„ Preview:\n{full_text[:500]}...")
              
          except Exception as e:
              print(f"âŒ Error: {e}")
              exit(1)
          PYTHON
      
      - name: Upload Transcript
        uses: actions/upload-artifact@v4
        with:
          name: youtube-transcript
          path: transcript_output.txt
