name: YouTube Transcript Agent V8

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true
        type: string

jobs:
  transcript:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install --break-system-packages requests youtube-transcript-api
      
      - name: Extract Transcript
        env:
          VIDEO_URL: ${{ inputs.video_url }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          import json
          import os
          import re
          from youtube_transcript_api import YouTubeTranscriptApi
          from youtube_transcript_api._errors import TranscriptsDisabled, NoTranscriptFound

          def extract_video_id(url):
              """Extract video ID from YouTube URL"""
              patterns = [
                  r'(?:v=|\/)([0-9A-Za-z_-]{11}).*',
                  r'youtu\.be\/([0-9A-Za-z_-]{11})',
              ]
              for pattern in patterns:
                  match = re.search(pattern, url)
                  if match:
                      return match.group(1)
              return None

          def get_video_metadata(video_id, api_key):
              """Get video metadata using YouTube Data API v3"""
              url = "https://www.googleapis.com/youtube/v3/videos"
              params = {
                  'part': 'snippet,contentDetails,statistics',
                  'id': video_id,
                  'key': api_key
              }
              
              response = requests.get(url, params=params)
              data = response.json()
              
              if 'items' in data and len(data['items']) > 0:
                  return data['items'][0]
              return None

          def format_transcript(transcript_data):
              """Format transcript from youtube-transcript-api"""
              formatted = []
              for entry in transcript_data:
                  text = entry['text'].strip()
                  if text:
                      formatted.append(text)
              return ' '.join(formatted)

          # Main execution
          video_url = os.environ['VIDEO_URL']
          api_key = os.environ['GOOGLE_API_KEY']
          
          video_id = extract_video_id(video_url)
          print(f"üìπ Video ID: {video_id}")
          
          # Get video metadata
          print("üîç Fetching video metadata...")
          metadata = get_video_metadata(video_id, api_key)
          
          if not metadata:
              print("‚ùå Video not found or private")
              exit(1)
          
          snippet = metadata['snippet']
          stats = metadata.get('statistics', {})
          
          print(f"‚úÖ Video: {snippet['title']}")
          print(f"üì∫ Channel: {snippet['channelTitle']}")
          print(f"üëÅÔ∏è  Views: {stats.get('viewCount', 'N/A')}")
          
          # Try to get transcript using youtube-transcript-api
          transcript_text = None
          method = "None"
          
          try:
              print("\nüé¨ Method 1: Attempting auto-generated captions...")
              transcript_list = YouTubeTranscriptApi.get_transcript(video_id)
              transcript_text = format_transcript(transcript_list)
              method = "Auto-generated captions (youtube-transcript-api)"
              print("‚úÖ Success with auto-generated captions!")
              
          except NoTranscriptFound:
              print("‚ö†Ô∏è  No auto-generated captions found")
              try:
                  print("üé¨ Method 2: Attempting manual captions...")
                  transcript_list = YouTubeTranscriptApi.list_transcripts(video_id)
                  transcript = transcript_list.find_manually_created_transcript(['en'])
                  transcript_text = format_transcript(transcript.fetch())
                  method = "Manual captions (youtube-transcript-api)"
                  print("‚úÖ Success with manual captions!")
              except:
                  print("‚ö†Ô∏è  No manual captions available")
                  
          except TranscriptsDisabled:
              print("‚ùå Transcripts are disabled for this video")
              
          except Exception as e:
              print(f"‚ö†Ô∏è  Transcript extraction failed: {str(e)}")
          
          # Write output
          with open('transcript_output.txt', 'w', encoding='utf-8') as f:
              f.write("=" * 80 + "\n")
              f.write("YOUTUBE VIDEO TRANSCRIPT\n")
              f.write("=" * 80 + "\n\n")
              f.write(f"Title: {snippet['title']}\n")
              f.write(f"Channel: {snippet['channelTitle']}\n")
              f.write(f"Published: {snippet['publishedAt']}\n")
              f.write(f"URL: {video_url}\n")
              f.write(f"Views: {stats.get('viewCount', 'N/A')}\n")
              f.write(f"Likes: {stats.get('likeCount', 'N/A')}\n")
              f.write(f"Method: {method}\n\n")
              f.write("=" * 80 + "\n")
              f.write("DESCRIPTION\n")
              f.write("=" * 80 + "\n\n")
              f.write(snippet.get('description', 'No description available') + "\n\n")
              f.write("=" * 80 + "\n")
              f.write("TRANSCRIPT\n")
              f.write("=" * 80 + "\n\n")
              
              if transcript_text:
                  f.write(transcript_text + "\n")
              else:
                  f.write("‚ö†Ô∏è  No transcript available for this video.\n\n")
                  f.write("Note: This could mean:\n")
                  f.write("- The video has no captions/subtitles\n")
                  f.write("- Captions are disabled by the creator\n")
                  f.write("- The video is too new (captions not generated yet)\n")
          
          print("\n‚úÖ Output saved to transcript_output.txt")
          print("\n" + "=" * 80)
          with open('transcript_output.txt', 'r', encoding='utf-8') as f:
              print(f.read())
          
          PYTHON_SCRIPT
      
      - name: Upload Transcript
        uses: actions/upload-artifact@v4
        with:
          name: youtube-transcript
          path: transcript_output.txt
          retention-days: 30
