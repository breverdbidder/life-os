name: YouTube Transcript Agent

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true
        type: string

jobs:
  transcript:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install --break-system-packages requests
      
      - name: Extract Transcript via Apify
        env:
          VIDEO_URL: ${{ inputs.video_url }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          import json
          import time
          import os
          import re

          def extract_video_id(url):
              patterns = [
                  r'(?:v=|\/)([0-9A-Za-z_-]{11}).*',
                  r'youtu\.be\/([0-9A-Za-z_-]{11})',
              ]
              for pattern in patterns:
                  match = re.search(pattern, url)
                  if match:
                      return match.group(1)
              return None

          video_url = os.environ['VIDEO_URL']
          video_id = extract_video_id(video_url)
          
          print(f"üìπ Video ID: {video_id}")
          print(f"üîÑ Starting Apify actor...")

          # Start actor run
          actor_input = {
              "startUrls": [{"url": f"https://www.youtube.com/watch?v={video_id}"}],
              "maxResults": 1
          }

          response = requests.post(
              "https://api.apify.com/v2/acts/streamers~youtube-scraper/runs?token=apify_api_REdm4BQGUAVJlt7CEnWz5BdXP0gqYP1v39eB",
              json=actor_input
          )
          
          run_id = response.json()['data']['id']
          print(f"üé¨ Run ID: {run_id}")
          
          # Wait for completion
          for i in range(60):
              time.sleep(5)
              status_response = requests.get(
                  f"https://api.apify.com/v2/acts/streamers~youtube-scraper/runs/{run_id}?token=apify_api_REdm4BQGUAVJlt7CEnWz5BdXP0gqYP1v39eB"
              )
              status = status_response.json()['data']['status']
              print(f"‚è≥ Status: {status}")
              
              if status == 'SUCCEEDED':
                  break
          
          # Get dataset
          dataset_id = status_response.json()['data']['defaultDatasetId']
          items_response = requests.get(
              f"https://api.apify.com/v2/datasets/{dataset_id}/items?token=apify_api_REdm4BQGUAVJlt7CEnWz5BdXP0gqYP1v39eB"
          )
          
          items = items_response.json()
          if items and len(items) > 0:
              video = items[0]
              
              # Write transcript
              with open('transcript_output.txt', 'w') as f:
                  f.write("="*80 + "\n")
                  f.write("YOUTUBE VIDEO TRANSCRIPT\n")
                  f.write("="*80 + "\n\n")
                  f.write(f"Title: {video.get('title', 'N/A')}\n")
                  f.write(f"Channel: {video.get('channelName', 'N/A')}\n")
                  f.write(f"URL: {video_url}\n")
                  f.write(f"Method: Apify YouTube Scraper\n\n")
                  f.write("="*80 + "\n")
                  f.write("TRANSCRIPT\n")
                  f.write("="*80 + "\n\n")
                  
                  if 'subtitles' in video and video['subtitles']:
                      f.write(video['subtitles'])
                  else:
                      f.write("No transcript available for this video.\n")
              
              print("‚úÖ Transcript saved!")
              with open('transcript_output.txt', 'r') as f:
                  print(f.read())
          else:
              print("‚ùå No video data returned")
              exit(1)
          PYTHON_SCRIPT
      
      - name: Upload Transcript
        uses: actions/upload-artifact@v4
        with:
          name: youtube-transcript
          path: transcript_output.txt
