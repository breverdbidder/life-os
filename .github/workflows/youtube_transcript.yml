name: YouTube Transcript Agent V7

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true
        type: string

jobs:
  transcript:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install --break-system-packages requests
      
      - name: Extract Transcript via Apify
        env:
          VIDEO_URL: ${{ inputs.video_url }}
          APIFY_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          import json
          import time
          import os
          import re

          def extract_video_id(url):
              patterns = [
                  r'(?:v=|\/)([0-9A-Za-z_-]{11}).*',
                  r'youtu\.be\/([0-9A-Za-z_-]{11})',
              ]
              for pattern in patterns:
                  match = re.search(pattern, url)
                  if match:
                      return match.group(1)
              return None

          video_url = os.environ['VIDEO_URL']
          apify_token = os.environ['APIFY_TOKEN']
          video_id = extract_video_id(video_url)
          
          print(f"üìπ Video ID: {video_id}")
          print(f"üîÑ Starting Apify YouTube Scraper...")

          # Start actor run
          actor_input = {
              "startUrls": [{"url": f"https://www.youtube.com/watch?v={video_id}"}],
              "maxResults": 1
          }

          response = requests.post(
              f"https://api.apify.com/v2/acts/streamers~youtube-scraper/runs?token={apify_token}",
              json=actor_input
          )
          
          if response.status_code != 201:
              print(f"‚ùå Failed to start actor: {response.status_code}")
              print(response.text)
              exit(1)
          
          run_id = response.json()['data']['id']
          print(f"üé¨ Run ID: {run_id}")
          
          # Wait for completion
          for i in range(60):
              time.sleep(5)
              status_response = requests.get(
                  f"https://api.apify.com/v2/acts/streamers~youtube-scraper/runs/{run_id}?token={apify_token}"
              )
              status = status_response.json()['data']['status']
              print(f"‚è≥ Status check {i+1}/60: {status}")
              
              if status == 'SUCCEEDED':
                  break
              elif status in ['FAILED', 'ABORTED', 'TIMED-OUT']:
                  print(f"‚ùå Actor run {status}")
                  exit(1)
          
          # Get dataset
          dataset_id = status_response.json()['data']['defaultDatasetId']
          items_response = requests.get(
              f"https://api.apify.com/v2/datasets/{dataset_id}/items?token={apify_token}"
          )
          
          items = items_response.json()
          if items and len(items) > 0:
              video = items[0]
              
              # Write transcript
              with open('transcript_output.txt', 'w', encoding='utf-8') as f:
                  f.write("="*80 + "\n")
                  f.write("YOUTUBE VIDEO TRANSCRIPT\n")
                  f.write("="*80 + "\n\n")
                  f.write(f"Title: {video.get('title', 'N/A')}\n")
                  f.write(f"Channel: {video.get('channelName', 'N/A')}\n")
                  f.write(f"URL: {video_url}\n")
                  f.write(f"Views: {video.get('viewCount', 'N/A')}\n")
                  f.write(f"Likes: {video.get('likesCount', 'N/A')}\n")
                  f.write(f"Published: {video.get('date', 'N/A')}\n")
                  f.write(f"Method: Apify YouTube Scraper\n\n")
                  f.write("="*80 + "\n")
                  f.write("DESCRIPTION\n")
                  f.write("="*80 + "\n\n")
                  f.write(video.get('description', 'No description available') + "\n\n")
                  f.write("="*80 + "\n")
                  f.write("TRANSCRIPT\n")
                  f.write("="*80 + "\n\n")
                  
                  if 'subtitles' in video and video['subtitles']:
                      f.write(video['subtitles'])
                  else:
                      f.write("‚ö†Ô∏è  No transcript/subtitles available for this video.\n")
              
              print("\n‚úÖ Transcript saved!")
              print("\n" + "="*80)
              with open('transcript_output.txt', 'r', encoding='utf-8') as f:
                  print(f.read())
          else:
              print("‚ùå No video data returned")
              exit(1)
          PYTHON_SCRIPT
      
      - name: Upload Transcript
        uses: actions/upload-artifact@v4
        with:
          name: youtube-transcript
          path: transcript_output.txt
          retention-days: 30
