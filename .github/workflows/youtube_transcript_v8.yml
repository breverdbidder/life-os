name: YouTube Transcript V8 - Fixed

on:
  workflow_dispatch:
    inputs:
      youtube_url:
        description: 'YouTube URL to transcribe'
        required: true
        type: string

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  transcript:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Install dependencies
        run: |
          pip install youtube-transcript-api openai yt-dlp supabase --break-system-packages
          sudo apt-get update && sudo apt-get install -y ffmpeg
      
      - name: Extract Transcript
        id: extract
        run: |
          python3 << 'EOF'
          import re
          import os
          import sys
          from datetime import datetime
          
          # Tier 1: YouTube API
          try:
              from youtube_transcript_api._api import YouTubeTranscriptApi
              
              url = "${{ github.event.inputs.youtube_url }}"
              video_id = re.search(r'(?:v=|/)([0-9A-Za-z_-]{11})', url).group(1)
              
              print(f"Video ID: {video_id}")
              print("Tier 1: YouTube Transcript API (FREE)...")
              
              api = YouTubeTranscriptApi()
              transcript_list = api.list(video_id)
              
              # Get first available transcript
              transcript_obj = list(transcript_list)[0]
              transcript_data = transcript_obj.fetch()
              
              # Combine segments
              full_text = ' '.join([entry['text'] for entry in transcript_data])
              full_text = re.sub(r'\s+', ' ', full_text).strip()
              
              # Save transcript
              output_path = f"/tmp/transcript_{video_id}.txt"
              with open(output_path, 'w') as f:
                  f.write(full_text)
              
              print(f"SUCCESS - Tier 1")
              print(f"Length: {len(full_text)} chars")
              print(f"Output: {output_path}")
              
              # Set outputs
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"success=true\n")
                  f.write(f"transcript_path={output_path}\n")
                  f.write(f"tier=1\n")
                  f.write(f"video_id={video_id}\n")
              
          except Exception as e:
              print(f"Tier 1 failed: {e}")
              
              # Tier 2: yt-dlp + Whisper
              try:
                  import subprocess
                  from openai import OpenAI
                  
                  print("\nTier 2: yt-dlp + Whisper...")
                  
                  audio_path = f"/tmp/audio_{video_id}.mp3"
                  cmd = [
                      "yt-dlp",
                      "-f", "bestaudio",
                      "--extract-audio",
                      "--audio-format", "mp3",
                      "-o", audio_path.replace(".mp3", ".%(ext)s"),
                      url
                  ]
                  
                  subprocess.run(cmd, check=True, timeout=300)
                  print(f"Audio downloaded: {audio_path}")
                  
                  # Transcribe with Whisper
                  client = OpenAI()
                  with open(audio_path, "rb") as f:
                      result = client.audio.transcriptions.create(
                          model="whisper-1",
                          file=f,
                          response_format="text"
                      )
                  
                  full_text = re.sub(r'\s+', ' ', result).strip()
                  
                  # Save
                  output_path = f"/tmp/transcript_{video_id}.txt"
                  with open(output_path, 'w') as f:
                      f.write(full_text)
                  
                  print(f"SUCCESS - Tier 2")
                  print(f"Length: {len(full_text)} chars")
                  
                  # Set outputs
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"success=true\n")
                      f.write(f"transcript_path={output_path}\n")
                      f.write(f"tier=2\n")
                      f.write(f"video_id={video_id}\n")
                  
                  # Cleanup
                  if os.path.exists(audio_path):
                      os.remove(audio_path)
                  
              except Exception as e2:
                  print(f"Tier 2 failed: {e2}")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"success=false\n")
                  sys.exit(1)
          
          EOF
      
      - name: Generate Summary
        if: steps.extract.outputs.success == 'true'
        id: summary
        run: |
          python3 << 'EOF'
          import os
          from openai import OpenAI
          
          video_id = "${{ steps.extract.outputs.video_id }}"
          transcript_path = "${{ steps.extract.outputs.transcript_path }}"
          
          # Read transcript
          with open(transcript_path, 'r') as f:
              transcript = f.read()
          
          # Generate summary
          client = OpenAI()
          response = client.chat.completions.create(
              model="gpt-4o-mini",
              messages=[{
                  "role": "user",
                  "content": f"Provide a comprehensive summary of this YouTube video transcript. Include:\n1. Main topics (2-3 sentences)\n2. Key points (3-5 bullet points)\n3. Conclusion (1-2 sentences)\n\nTranscript:\n{transcript[:8000]}"
              }],
              max_tokens=1000
          )
          
          summary = response.choices[0].message.content
          
          # Save summary
          summary_path = f"/tmp/summary_{video_id}.md"
          with open(summary_path, 'w') as f:
              f.write(f"# Video Summary\n\n")
              f.write(f"**Video ID:** {video_id}\n")
              f.write(f"**URL:** ${{ github.event.inputs.youtube_url }}\n")
              f.write(f"**Tier:** ${{ steps.extract.outputs.tier }}\n\n")
              f.write(f"---\n\n")
              f.write(summary)
              f.write(f"\n\n---\n\n")
              f.write(f"**Transcript Length:** {len(transcript)} characters\n")
          
          print(f"Summary generated: {summary_path}")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"summary_path={summary_path}\n")
          
          EOF
      
      - name: Upload to Supabase
        if: steps.extract.outputs.success == 'true'
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime
          from supabase import create_client
          
          supabase = create_client(
              os.environ['SUPABASE_URL'],
              os.environ['SUPABASE_KEY']
          )
          
          # Read files
          transcript_path = "${{ steps.extract.outputs.transcript_path }}"
          summary_path = "${{ steps.summary.outputs.summary_path }}"
          
          with open(transcript_path, 'r') as f:
              transcript = f.read()
          
          with open(summary_path, 'r') as f:
              summary = f.read()
          
          # Insert to insights
          data = {
              "category": "youtube_transcript_v8",
              "title": f"YouTube - ${{ steps.extract.outputs.video_id }}",
              "description": f"Extracted via Tier ${{ steps.extract.outputs.tier }}",
              "value": transcript,
              "metadata": {
                  "url": "${{ github.event.inputs.youtube_url }}",
                  "video_id": "${{ steps.extract.outputs.video_id }}",
                  "tier": "${{ steps.extract.outputs.tier }}",
                  "summary": summary,
                  "length": len(transcript),
                  "timestamp": datetime.now().isoformat()
              }
          }
          
          result = supabase.table('insights').insert(data).execute()
          print(f"Saved to Supabase: {result.data[0]['id']}")
          
          EOF
      
      - name: Create Combined Report
        if: steps.extract.outputs.success == 'true'
        run: |
          cat << 'EOF' > /tmp/report.md
          # YouTube Transcript V8 - Success
          
          **Video:** ${{ github.event.inputs.youtube_url }}  
          **Video ID:** ${{ steps.extract.outputs.video_id }}  
          **Method:** Tier ${{ steps.extract.outputs.tier }}  
          **Status:** âœ… SUCCESS
          
          ---
          
          ## Summary
          
          EOF
          cat ${{ steps.summary.outputs.summary_path }} >> /tmp/report.md
          echo -e "\n\n---\n\n## Full Transcript\n" >> /tmp/report.md
          head -c 5000 ${{ steps.extract.outputs.transcript_path }} >> /tmp/report.md
          echo -e "\n\n[...transcript continues...]\n" >> /tmp/report.md
          cat /tmp/report.md > $GITHUB_STEP_SUMMARY
      
      - name: Upload artifacts
        if: steps.extract.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: youtube-transcript-${{ steps.extract.outputs.video_id }}
          path: |
            ${{ steps.extract.outputs.transcript_path }}
            ${{ steps.summary.outputs.summary_path }}
          retention-days: 30
